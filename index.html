<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¾’æ­¥ç’°å³¶ç´€éŒ„ v7</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Chart.js (çµ±è¨ˆåœ–è¡¨ç”¨) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { bg: '#FDFCF8', dark: '#2C5E50', light: '#E8F5E9', earth: '#A39274', accent: '#E76F51', text: '#333333' }
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'], num: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #FDFCF8; color: #333; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); }
        .input-field { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #E5E7EB; background: #FAFAFA; outline: none; transition: 0.2s; font-size: 16px; }
        .input-field:focus { border-color: #2C5E50; background: white; }
        .fab { position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background-color: #2C5E50; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(44, 94, 80, 0.4); font-size: 24px; z-index: 50; cursor: pointer; }
        .nav-item.active { color: #2C5E50; } .nav-item { color: #A8A29E; transition: 0.3s; }
        #map-picker-container { height: 100%; width: 100%; z-index: 10; }
        .custom-pin { text-align: center; }
        .pin-number { background: #2C5E50; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; line-height: 24px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); font-weight: bold; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden font-sans">

    <!-- Header -->
    <header class="flex-none bg-brand-bg px-5 py-4 flex justify-between items-center shadow-sm z-10 border-b border-gray-100">
        <h1 class="text-xl font-bold text-brand-dark tracking-wide flex items-center"><i class="fa-solid fa-person-hiking mr-2"></i>Island Walker</h1>
        <div id="total-stats" class="text-xs font-bold font-num text-brand-earth bg-brand-light px-3 py-1 rounded-full border border-brand-earth/20">Loading...</div>
    </header>

    <!-- Main -->
    <main id="app-container" class="flex-1 overflow-y-auto no-scrollbar p-5 pb-24 scroll-smooth relative"></main>

    <!-- Nav -->
    <nav class="flex-none bg-white border-t border-gray-100 pb-safe flex justify-around items-center h-20 fixed bottom-0 w-full z-[60]">
        <button onclick="App.router('log')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-log"><i class="fa-solid fa-shoe-prints text-xl mb-1"></i><span class="text-[10px] font-medium">ç´€éŒ„</span></button>
        <button onclick="App.router('route')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-route"><i class="fa-solid fa-map-location-dot text-xl mb-1"></i><span class="text-[10px] font-medium">è¦åŠƒ</span></button>
        <button onclick="App.router('stay')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-stay"><i class="fa-solid fa-bed text-xl mb-1"></i><span class="text-[10px] font-medium">ä½å®¿</span></button>
        <button onclick="App.router('gear')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-gear"><i class="fa-solid fa-suitcase text-xl mb-1"></i><span class="text-[10px] font-medium">è£å‚™</span></button>
        <button onclick="App.router('stats')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-stats"><i class="fa-solid fa-chart-pie text-xl mb-1"></i><span class="text-[10px] font-medium">çµ±è¨ˆ</span></button>
    </nav>

    <!-- Generic Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-5 shadow-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-none border-b pb-3">
                <h3 id="modal-title" class="text-lg font-bold text-brand-dark">æ¨™é¡Œ</h3>
                <button onclick="App.closeModal()" class="text-gray-400 hover:text-gray-600 px-2"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="modal-content" class="flex-1 overflow-y-auto no-scrollbar space-y-4"></div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-5 shadow-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-none border-b pb-3">
                <h3 class="text-lg font-bold text-brand-dark">é¸æ“‡è¦åŠƒè·¯ç·šåŒ¯å…¥</h3>
                <button onclick="App.closeImportModal()" class="text-gray-400 px-2"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="import-list" class="flex-1 overflow-y-auto space-y-3"></div>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="map-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[90] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl h-[95vh] flex flex-col overflow-hidden">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center flex-none">
                <h3 class="font-bold text-brand-dark text-sm flex items-center gap-2"><i class="fa-solid fa-person-walking text-brand-dark"></i> æ¸¬è· (OSM æ­¥è¡Œæ¨¡å¼)</h3>
                <button onclick="App.closeMapModal()" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-3 bg-white flex-none max-h-[30vh] overflow-y-auto border-b">
                <div class="text-[10px] text-red-500 mb-2 bg-red-50 p-2 rounded border border-red-100 font-bold">
                    <i class="fa-solid fa-triangle-exclamation"></i> æé†’ï¼šç´…ç·šåƒ…ç‚ºä¼°ç®—è·¯å¾‘ï¼Œè‹¥é¡¯ç¤ºèµ°å¿«é€Ÿé“è·¯è«‹å‹¿åƒè€ƒã€‚æœå°‹åº—å®¶è«‹åŠ ç¸£å¸‚ (å¦‚ï¼šå°æ± 7-11)ã€‚
                </div>
                <div id="stops-list" class="space-y-2"></div>
                <button onclick="MapPicker.addStopInput()" class="mt-2 text-xs font-bold text-brand-dark flex items-center gap-1 hover:bg-gray-100 px-2 py-1 rounded"><i class="fa-solid fa-plus-circle"></i> å¢åŠ é€”ç¶“é»</button>
            </div>
            <div class="p-2 flex gap-2 items-center bg-white border-b flex-none z-10 shadow-sm">
                <button onclick="MapPicker.processInputs()" class="flex-1 bg-brand-dark text-white py-2 rounded-lg font-bold text-sm shadow"><i class="fa-solid fa-calculator mr-1"></i> è¨ˆç®—è·¯å¾‘</button>
                <div class="flex-1 text-right pr-2"><div class="text-xs text-gray-500">ä¼°è¨ˆè·é›¢</div><div class="text-lg font-bold text-brand-accent font-num" id="map-result-text">0.0 km</div></div>
            </div>
            <div class="flex-1 relative bg-gray-100">
                <div id="map-picker-container"></div>
                <div class="absolute bottom-4 left-4 right-4 z-[999]"><button onclick="MapPicker.confirm()" id="btn-map-confirm" disabled class="w-full bg-brand-accent text-white py-3 rounded-xl font-bold shadow-lg disabled:opacity-50 disabled:translate-y-20 transition-all transform">ç¢ºèªä¸¦å¸¶å…¥</button></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const Utils = {
            weekDays: ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'],
            formatDate(dateStr) { 
                if(!dateStr) return ''; 
                const d = new Date(dateStr); 
                return `${dateStr} ${this.weekDays[d.getDay()]}`; 
            },
            // ä¿®æ­£ Day 1 å•é¡Œï¼šå°‡æ™‚é–“çµ±ä¸€æ­¸é›¶åˆ°åˆå¤œ
            getMidnight(dateStr) { 
                const d = new Date(dateStr); 
                d.setHours(0,0,0,0); 
                return d; 
            }
        };

        const MapPicker = {
            map: null, stops: [], polyline: null, targetInputId: null, calculatedKm: 0,
            
            init() { 
                if (this.map) return; 
                this.map = L.map('map-picker-container', { zoomControl: false }).setView([23.58, 120.58], 7); 
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OSM' }).addTo(this.map); 
                if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(pos => { this.map.setView([pos.coords.latitude, pos.coords.longitude], 12); }); } 
            },
            open(inputId) { 
                this.targetInputId = inputId; 
                document.getElementById('map-modal').classList.remove('hidden'); 
                setTimeout(() => { this.init(); this.map.invalidateSize(); }, 100); 
                if(this.stops.length === 0) this.reset(); else this.cleanMapLayers(); 
            },
            reset() { 
                this.stops = []; 
                document.getElementById('stops-list').innerHTML = ''; 
                this.addStopInput('èµ·é» (ç¸£å¸‚+åº—å/åœ°å€)'); 
                this.addStopInput('çµ‚é» (ç¸£å¸‚+åº—å/åœ°å€)'); 
                this.cleanMapLayers(); 
            },
            cleanMapLayers() { 
                if(this.polyline) this.map.removeLayer(this.polyline); 
                this.stops.forEach(s => { if(s.marker) this.map.removeLayer(s.marker); s.coords = null; s.marker = null; }); 
                this.calculatedKm = 0; 
                document.getElementById('map-result-text').innerText = '0.0 km'; 
                document.getElementById('btn-map-confirm').disabled = true; 
            },
            addStopInput(placeholder = 'é€”ç¶“é»') { 
                const id = Date.now() + Math.random(); 
                const stop = { id, text: '', coords: null, marker: null }; 
                this.stops.push(stop); 
                this.renderStopList(); 
            },
            removeStop(id) { 
                if(this.stops.length <= 2) return alert('è‡³å°‘éœ€è¦èµ·é»å’Œçµ‚é»'); 
                const idx = this.stops.findIndex(s => s.id === id); 
                if(this.stops[idx].marker) this.map.removeLayer(this.stops[idx].marker); 
                this.stops = this.stops.filter(s => s.id !== id); 
                this.renderStopList(); 
                this.cleanMapLayers(); 
            },
            renderStopList() { 
                const container = document.getElementById('stops-list'); 
                container.innerHTML = ''; 
                this.stops.forEach((stop, index) => { 
                    const isStart = index === 0; 
                    const isEnd = index === this.stops.length - 1; 
                    const label = isStart ? 'èµ·' : isEnd ? 'çµ‚' : (index); 
                    const colorClass = isStart ? 'bg-brand-dark' : isEnd ? 'bg-brand-accent' : 'bg-gray-400'; 
                    const div = document.createElement('div'); 
                    div.className = 'flex items-center gap-2 animate-[fadeIn_0.2s]'; 
                    div.innerHTML = `<div class="flex-none w-6 h-6 rounded-full ${colorClass} text-white text-xs font-bold flex items-center justify-center">${label}</div><input type="text" class="flex-1 bg-gray-100 rounded-lg px-3 py-2 text-sm border border-transparent focus:bg-white focus:border-brand-dark outline-none transition" placeholder="${isStart?'è¼¸å…¥èµ·é» (ç¸£å¸‚+åº—å)...':isEnd?'è¼¸å…¥çµ‚é»...':'è¼¸å…¥é€”ç¶“é»...'}" value="${stop.text}">${this.stops.length > 2 ? `<button onclick="MapPicker.removeStop(${stop.id})" class="text-gray-300 hover:text-red-400 px-1"><i class="fa-solid fa-xmark"></i></button>` : ''}`; 
                    div.querySelector('input').addEventListener('input', (e) => stop.text = e.target.value); 
                    container.appendChild(div); 
                }); 
            },
            async processInputs() { 
                const inputs = this.stops.filter(s => s.text.trim() !== ''); 
                if (inputs.length < 2) return alert('è«‹è‡³å°‘è¼¸å…¥èµ·é»å’Œçµ‚é»'); 
                document.getElementById('map-result-text').innerText = 'å®šä½ä¸­...'; 
                this.stops.forEach(s => { if(s.marker) this.map.removeLayer(s.marker); }); 
                for (let i = 0; i < inputs.length; i++) { 
                    const stop = inputs[i]; 
                    try { 
                        const coords = await this.smartGeocode(stop.text); 
                        if (coords) { stop.coords = coords; this.addMarker(stop, i); } 
                        else { alert(`æ‰¾ä¸åˆ°: ${stop.text} (å»ºè­°åŠ ä¸Šç¸£å¸‚åç¨±)`); document.getElementById('map-result-text').innerText = 'å®šä½å¤±æ•—'; return; } 
                        await new Promise(r => setTimeout(r, 600)); 
                    } catch (e) { alert('ç¶²è·¯éŒ¯èª¤'); return; } 
                } 
                this.calculateRoute(); 
            },
            async smartGeocode(query) { 
                let res = await this.geocode(query); if (res) return res; 
                // Retry strategy: Remove Zip or House No
                const noZip = query.replace(/^\d{3,5}/, '').trim(); if (noZip !== query) { res = await this.geocode(noZip); if (res) return res; } 
                const noHouse = noZip.replace(/\d+(è™Ÿ|F|æ¨“|f).*/, '').trim(); if (noHouse !== noZip && noHouse.length > 1) { res = await this.geocode(noHouse); if (res) return res; } 
                return null; 
            },
            async geocode(query) { 
                try { 
                    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`; 
                    const res = await fetch(url); const data = await res.json(); 
                    if (data && data.length > 0) return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) }; 
                } catch(e) { return null; } 
                return null; 
            },
            addMarker(stop, index) { 
                const label = (index + 1).toString(); const html = `<div class="pin-number">${label}</div>`; 
                const icon = L.divIcon({ className: 'custom-pin', html: html, iconSize: [24, 24] }); 
                const marker = L.marker([stop.coords.lat, stop.coords.lng], { icon: icon, draggable: true }).addTo(this.map); 
                marker.on('dragend', (e) => { stop.coords = e.target.getLatLng(); this.calculateRoute(); }); 
                stop.marker = marker; 
            },
            async calculateRoute() { 
                const activeStops = this.stops.filter(s => s.coords); if (activeStops.length < 2) return; 
                document.getElementById('map-result-text').innerText = 'ä¼°ç®—ä¸­...'; 
                const coordString = activeStops.map(s => `${s.coords.lng},${s.coords.lat}`).join(';'); 
                // Use OSRM foot profile
                const url = `https://router.project-osrm.org/route/v1/foot/${coordString}?overview=full&geometries=geojson`; 
                try { 
                    const res = await fetch(url); const data = await res.json(); 
                    if (data.code === 'Ok' && data.routes.length > 0) { 
                        const route = data.routes[0]; this.calculatedKm = (route.distance / 1000).toFixed(2); 
                        document.getElementById('map-result-text').innerText = `${this.calculatedKm} km`; document.getElementById('btn-map-confirm').disabled = false; 
                        if (this.polyline) this.map.removeLayer(this.polyline); 
                        const latlngs = route.geometry.coordinates.map(c => [c[1], c[0]]); 
                        // Dash array added to indicate rough path
                        this.polyline = L.polyline(latlngs, { color: '#ef4444', weight: 4, opacity: 0.7, dashArray: '10, 10' }).addTo(this.map); 
                        this.map.fitBounds(this.polyline.getBounds(), { padding: [50, 50] }); 
                    } 
                } catch (e) { document.getElementById('map-result-text').innerText = 'è¨ˆç®—å¤±æ•—'; } 
            },
            confirm() { 
                if (this.targetInputId) document.getElementById(this.targetInputId).value = this.calculatedKm; 
                const active = this.stops.filter(s => s.coords); 
                if(active.length >= 2) { 
                    window.tempMapCoords = { start: active[0].coords, end: active[active.length-1].coords, waypoints: active.slice(1, -1).map(s => s.coords) }; 
                    const startInput = document.getElementById(this.targetInputId.replace('km', 'start')); 
                    const endInput = document.getElementById(this.targetInputId.replace('km', 'end')); 
                    if(startInput && !startInput.value) startInput.value = active[0].text; 
                    if(endInput && !endInput.value) endInput.value = active[active.length-1].text; 
                } 
                App.closeMapModal(); 
            }
        };

        const App = {
            data: { logs: [], routes: [], stays: [], gears: [], health: [], targetKm: 1200 },
            currentView: 'log', firstDate: null, chartInstance: null,

            init() {
                try {
                    this.loadData();
                    this.router('log');
                    if(this.data.gears.length === 0) this.seedGearData();
                    window.App = this; window.MapPicker = MapPicker;
                } catch(e) { console.error(e); }
            },
            
            loadData() {
                const stored = localStorage.getItem('island_walker_v7_db');
                if (stored) {
                    this.data = JSON.parse(stored);
                } else if (localStorage.getItem('island_walker_v5_db')) { // Migration from v5
                    const v5 = JSON.parse(localStorage.getItem('island_walker_v5_db'));
                    this.data = { ...v5, targetKm: 1200 }; // Default target
                    this.saveData();
                } else if (localStorage.getItem('island_walker_v4_db')) { // Migration from v4
                    const v4 = JSON.parse(localStorage.getItem('island_walker_v4_db'));
                    this.data = { ...v4, targetKm: 1200 };
                    this.saveData();
                }
            },
            saveData() { 
                localStorage.setItem('island_walker_v7_db', JSON.stringify(this.data)); 
                this.calculateFirstDate(); 
                this.updateGlobalStats(); 
            },
            calculateFirstDate() { 
                if (this.data.logs.length > 0) { 
                    const sorted = [...this.data.logs].sort((a,b) => new Date(a.date) - new Date(b.date)); 
                    this.firstDate = sorted[0].date; 
                } else { this.firstDate = null; } 
            },
            // Fixed: Use Midnight comparison
            getDayNumber(dateStr) { 
                if (!this.firstDate) return 1; 
                const start = Utils.getMidnight(this.firstDate); 
                const current = Utils.getMidnight(dateStr); 
                // Difference in milliseconds
                const diffTime = current - start; 
                // Convert to days
                return Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1; 
            },
            updateGlobalStats() {
                const totalKm = this.data.logs.reduce((acc, curr) => acc + Number(curr.km || 0), 0);
                const today = new Date().toISOString().split('T')[0];
                const dayText = this.firstDate ? `Day ${this.getDayNumber(today)}` : 'æœªé–‹å§‹';
                document.getElementById('total-stats').innerText = `${dayText} â€¢ ç´¯ç© ${totalKm.toFixed(1)} km`;
            },
            router(view) {
                this.currentView = view;
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const nav = document.getElementById(`nav-${view}`);
                if(nav) nav.classList.add('active');
                
                const container = document.getElementById('app-container');
                window.scrollTo(0, 0);
                switch(view) {
                    case 'log': this.renderLogView(container); break;
                    case 'route': this.renderRouteView(container); break;
                    case 'stay': this.renderStayView(container); break;
                    case 'gear': this.renderGearView(container); break;
                    case 'stats': this.renderStatsView(container); break;
                }
                this.updateGlobalStats();
            },

            // --- Stats & Health View (New Feature) ---
            renderStatsView(container) {
                const totalKm = this.data.logs.reduce((acc, c) => acc + Number(c.km||0), 0);
                const progress = Math.min((totalKm / this.data.targetKm) * 100, 100).toFixed(1);
                
                // Expense Calc
                let stayTotal = 0, foodTotal = 0;
                this.data.logs.forEach(l => { 
                    stayTotal += this.getStayCostByDate(l.date); 
                    if(l.expenses) { l.expenses.forEach(e => foodTotal += Number(e.price)); } 
                    else if(l.otherCost) foodTotal += Number(l.otherCost); 
                });
                const totalCost = stayTotal + foodTotal;
                
                container.innerHTML = `
                    <div class="space-y-6 animate-[fadeIn_0.3s]">
                        <!-- Progress -->
                        <div class="card p-5 bg-gradient-to-br from-brand-dark to-[#1a4036] text-white relative overflow-hidden">
                            <i class="fa-solid fa-person-hiking absolute -right-4 -bottom-4 text-8xl text-white opacity-10"></i>
                            <div class="flex justify-between items-end mb-2">
                                <div><h3 class="text-sm opacity-80">ç’°å³¶é€²åº¦</h3><div class="text-3xl font-bold font-num">${totalKm.toFixed(1)} <span class="text-sm">km</span></div></div>
                                <div class="text-right"><div class="text-sm opacity-80">ç›®æ¨™ (é»æ“Šä¿®æ”¹)</div><div class="text-xl font-bold font-num cursor-pointer" onclick="App.editTarget()">${this.data.targetKm} <i class="fa-solid fa-pen text-xs opacity-50"></i></div></div>
                            </div>
                            <div class="w-full bg-white/20 rounded-full h-3 mb-1"><div class="bg-brand-accent h-3 rounded-full transition-all duration-1000" style="width: ${progress}%"></div></div>
                            <div class="text-right text-xs font-bold">${progress}% å®Œæˆ</div>
                        </div>

                        <!-- Chart -->
                        <div class="card p-5">
                            <h3 class="font-bold text-brand-dark mb-4 border-b pb-2">èŠ±è²»åˆ†æ (ç¸½è¨ˆ $${totalCost})</h3>
                            <div class="h-48 relative"><canvas id="expenseChart"></canvas></div>
                        </div>

                        <!-- Health Log List -->
                        <div class="flex justify-between items-center mt-6 mb-2"><h3 class="font-bold text-gray-500">å¥åº·ç‹€æ…‹ç´€éŒ„</h3><button onclick="App.openHealthModal()" class="text-xs bg-brand-dark text-white px-3 py-1.5 rounded-full shadow"><i class="fa-solid fa-plus"></i> æ–°å¢ç‹€æ…‹</button></div>
                        <div id="health-list" class="space-y-3 pb-10"></div>
                    </div>
                `;
                
                // Draw Chart
                setTimeout(() => { 
                    const ctx = document.getElementById('expenseChart'); 
                    if(ctx) { 
                        new Chart(ctx, { type: 'doughnut', data: { labels: ['ä½å®¿', 'é£²é£Ÿ/é›œæ”¯'], datasets: [{ data: [stayTotal, foodTotal], backgroundColor: ['#2C5E50', '#E76F51'], borderWidth: 0 }] }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } }); 
                    } 
                }, 100);
                
                // Render Health List
                const healthContainer = document.getElementById('health-list'); 
                if (this.data.health.length === 0) healthContainer.innerHTML = `<div class="text-center text-gray-300 py-4">ç„¡å¥åº·ç´€éŒ„</div>`; 
                else { 
                    this.data.health.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(h => { 
                        healthContainer.innerHTML += `<div class="card p-3 border-l-4 ${h.condition==='good'?'border-green-500':h.condition==='bad'?'border-red-500':'border-gray-400'}"><div class="flex justify-between text-xs mb-1"><span class="font-bold text-gray-600">${Utils.formatDate(h.date)}</span><span class="${h.condition==='good'?'text-green-600':'text-red-500'} font-bold">${h.condition==='good'?'è‰¯å¥½':h.condition==='bad'?'éœ€ä¼‘æ¯':'æ™®é€š'}</span></div><div class="text-sm">ç¡çœ  ${h.sleep}h ${h.pain?`â€¢ ç—›: ${h.pain}`:''}</div>${h.note?`<div class="text-xs text-gray-500 mt-1 bg-gray-50 p-1 rounded">${h.note}</div>`:''}</div>`; 
                    }); 
                }
            },
            editTarget() { 
                const newT = prompt('è¨­å®šç›®æ¨™å…¬é‡Œæ•¸', this.data.targetKm); 
                if(newT && !isNaN(newT)) { this.data.targetKm = Number(newT); this.saveData(); this.router('stats'); } 
            },

            // --- Log View ---
            renderLogView(container) {
                let html = ''; 
                if (this.data.logs.length === 0) html += `<div class="flex flex-col items-center justify-center h-[60vh] text-gray-300"><i class="fa-solid fa-person-hiking text-6xl mb-4"></i><p>é–‹å§‹ç´€éŒ„ä½ çš„ç¬¬ä¸€å¤©</p></div>`; 
                else { 
                    const sortedLogs = [...this.data.logs].sort((a,b) => new Date(b.date) - new Date(a.date)); 
                    sortedLogs.forEach(log => { 
                        const dayNum = this.getDayNumber(log.date); 
                        const stayCost = this.getStayCostByDate(log.date); 
                        const expenses = log.expenses || []; 
                        const totalCost = expenses.reduce((acc, curr) => acc + Number(curr.price), 0) + stayCost; 
                        let exHtml = ''; 
                        if(expenses.length > 0 || stayCost > 0) { 
                            exHtml = `<div class="mt-2 pt-2 border-t border-gray-100 text-xs text-gray-500 space-y-1">`; 
                            expenses.forEach(e => exHtml += `<div class="flex justify-between"><span>${e.name}</span><span>$${e.price}</span></div>`); 
                            if(stayCost > 0) exHtml += `<div class="flex justify-between text-blue-600"><span>ä½å®¿è²»</span><span>$${stayCost}</span></div>`; 
                            exHtml += `</div>`; 
                        } 
                        html += `<div class="card p-5 mb-5 border-l-[6px] border-brand-dark"><div class="flex justify-between items-start mb-3"><div><div class="text-xs font-bold font-num text-white bg-brand-earth px-2 py-1 rounded inline-block mb-1">Day ${dayNum}</div><div class="text-xs text-gray-400 font-num">${Utils.formatDate(log.date)}</div></div><button onclick="App.openLogModal(${log.id})" class="text-gray-300 p-2"><i class="fa-solid fa-pen-to-square"></i></button></div><h3 class="text-xl font-bold text-brand-dark mb-1 flex items-center">${log.start} <i class="fa-solid fa-arrow-right-long text-sm mx-2 text-gray-300"></i> ${log.end}</h3><div class="grid grid-cols-2 gap-3 my-3"><div class="bg-gray-50 p-2 rounded-lg"><div class="text-xs text-gray-400">é‡Œç¨‹</div><div class="font-bold text-brand-dark font-num text-lg">${log.km} <span class="text-xs">km</span></div></div><div class="bg-gray-50 p-2 rounded-lg"><div class="text-xs text-gray-400">ç¸½èŠ±è²»</div><div class="font-bold text-brand-accent font-num text-lg">$${totalCost}</div></div></div>${exHtml}<div class="text-sm text-gray-600 leading-relaxed whitespace-pre-line mt-3">${log.note || ''}</div></div>`; 
                    }); 
                } 
                container.innerHTML = html; 
                this.addFab(container, 'fa-plus', () => this.openLogModal()); 
            },

            // --- Route View ---
            renderRouteView(container) {
                let html = `<a href="https://www.google.com/maps" target="_blank" class="flex items-center justify-center bg-white text-brand-dark py-3 rounded-xl mb-6 shadow-sm border border-gray-100 font-bold"><i class="fa-brands fa-google text-lg mr-2 text-red-500"></i> é–‹å•Ÿ Google Maps</a>`;
                if (this.data.routes.length === 0) html += `<div class="text-center text-gray-400 mt-10">å°šæœªè¦åŠƒè·¯ç·š</div>`;
                else {
                    html += '<div class="relative border-l-2 border-brand-earth/30 ml-4 pl-6 py-2 space-y-6">';
                    this.data.routes.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(route => {
                        const isToday = route.date === new Date().toISOString().split('T')[0];
                        let navLink = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(route.start)}&destination=${encodeURIComponent(route.end)}&travelmode=walking`;
                        if (route.coords && route.coords.waypoints && route.coords.waypoints.length > 0) {
                             const waypoints = route.coords.waypoints.map(w => `${w.lat},${w.lng}`).join('|');
                             navLink = `https://www.google.com/maps/dir/?api=1&origin=${route.coords.start.lat},${route.coords.start.lng}&destination=${route.coords.end.lat},${route.coords.end.lng}&waypoints=${waypoints}&travelmode=walking`;
                        } else if (route.coords && route.coords.start) {
                             navLink = `https://www.google.com/maps/dir/?api=1&origin=${route.coords.start.lat},${route.coords.start.lng}&destination=${route.coords.end.lat},${route.coords.end.lng}&travelmode=walking`;
                        }
                        html += `<div class="relative group"><div class="absolute -left-[33px] top-4 w-4 h-4 rounded-full bg-brand-dark ${isToday ? 'ring-4 ring-brand-accent/30 bg-brand-accent' : ''}"></div><div class="card p-4 ${isToday ? 'border-2 border-brand-accent' : ''}"><div class="flex justify-between items-start mb-2"><div><span class="text-xs font-bold text-brand-earth font-num mb-1">Day ${route.dayNum}</span> <span class="text-xs text-gray-400 font-num">${Utils.formatDate(route.date)}</span></div><button onclick="App.openRouteModal(${route.id})" class="text-gray-300 px-2"><i class="fa-solid fa-pen"></i></button></div><h4 class="font-bold text-lg text-brand-dark mb-1">${route.start} â†’ ${route.end}</h4><div class="text-sm text-gray-600 mb-3 font-num font-medium">é ä¼°ï¼š${route.estKm} km</div><div class="flex gap-2 mt-3"><a href="${navLink}" target="_blank" class="flex-1 bg-brand-dark text-white py-2 rounded-lg text-xs font-bold text-center flex items-center justify-center"><i class="fa-solid fa-location-arrow mr-1"></i> å°èˆª</a>${route.note ? `<button onclick="alert('${route.note}')" class="px-3 bg-gray-100 rounded-lg text-gray-600"><i class="fa-solid fa-message"></i></button>` : ''}</div></div></div>`;
                    });
                    html += '</div>';
                }
                container.innerHTML = html;
                this.addFab(container, 'fa-map-pin', () => this.openRouteModal());
            },

            // --- Stay View (With Manual Link Field) ---
            renderStayView(container) {
                let html = '';
                if (this.data.stays.length === 0) html += `<div class="text-center text-gray-400 mt-20">å°šæœªç´€éŒ„ä½å®¿</div>`;
                else {
                    this.data.stays.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(stay => {
                        html += `<div class="card p-5 mb-4"><div class="flex justify-between items-start"><span class="text-xs font-bold text-gray-400 font-num">${Utils.formatDate(stay.date)}</span><button onclick="App.openStayModal(${stay.id})" class="text-gray-300 px-2"><i class="fa-solid fa-pen"></i></button></div><div class="flex justify-between items-center mt-1"><h3 class="text-xl font-bold text-brand-dark">${stay.name}</h3><span class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600">${stay.type}</span></div><div class="text-brand-accent font-bold my-2 font-num text-lg">$${stay.price}</div>${stay.contact ? `<div class="text-sm text-gray-600 mb-1"><i class="fa-solid fa-phone w-5"></i> <a href="tel:${stay.contact}" class="underline">${stay.contact}</a></div>` : ''}${stay.mapLink ? `<a href="${stay.mapLink}" target="_blank" class="mt-2 block text-center bg-brand-light py-2 rounded-lg text-sm font-bold text-brand-dark hover:bg-green-100"><i class="fa-solid fa-map-location-dot"></i> é–‹å•Ÿåœ°åœ–</a>` : ''}</div>`;
                    });
                }
                container.innerHTML = html;
                this.addFab(container, 'fa-bed', () => this.openStayModal());
            },

            // --- Gear View ---
            renderGearView(container) {
                container.innerHTML = `<div class="flex space-x-2 mb-4 sticky top-0 bg-brand-bg z-10 py-2"><button onclick="App.filterGear('all')" class="flex-1 py-2 bg-white rounded-lg shadow-sm text-xs font-bold border border-gray-100">å…¨éƒ¨</button><button onclick="App.filterGear('clothing')" class="flex-1 py-2 bg-white rounded-lg shadow-sm text-xs font-bold border border-gray-100">è¡£ç‰©</button><button onclick="App.filterGear('elec')" class="flex-1 py-2 bg-white rounded-lg shadow-sm text-xs font-bold border border-gray-100">é›»å­</button><button onclick="App.filterGear('med')" class="flex-1 py-2 bg-white rounded-lg shadow-sm text-xs font-bold border border-gray-100">é†«è—¥</button></div><div class="flex justify-between items-center mb-2 px-1"><h3 class="font-bold text-brand-dark">è£å‚™æ¸…å–®</h3><button onclick="App.openGearAdd()" class="text-sm text-brand-accent font-bold"><i class="fa-solid fa-plus"></i> æ–°å¢</button></div><div id="gear-list" class="space-y-3 pb-20"></div>`;
                this.filterGear('all');
            },

            // --- Helpers ---
            getStayCostByDate(date) { const stay = this.data.stays.find(s => s.date === date); return stay ? Number(stay.price || 0) : 0; },
            addFab(c,i,cb) { const b=document.createElement('div'); b.className='fab'; b.innerHTML=`<i class="fa-solid ${i}"></i>`; b.onclick=cb; c.appendChild(b); },
            showModal(t,h) { document.getElementById('modal-title').innerText=t; document.getElementById('modal-content').innerHTML=h; document.getElementById('modal').classList.remove('hidden'); },
            closeModal() { document.getElementById('modal').classList.add('hidden'); },
            closeMapModal() { document.getElementById('map-modal').classList.add('hidden'); },
            closeImportModal() { document.getElementById('import-modal').classList.add('hidden'); },

            // --- Modals ---
            openLogModal(editId = null) {
                const isEdit = editId !== null; let data = { expenses: [] }; if(isEdit) data = this.data.logs.find(l => l.id === editId); if(data.otherCost && (!data.expenses || data.expenses.length === 0)) data.expenses = [{name: 'é›œæ”¯', price: data.otherCost}]; const stayCost = isEdit ? this.getStayCostByDate(data.date) : 0;
                const formHtml = `<div class="space-y-4"><input type="date" id="log-date" class="input-field font-num" value="${data.date || new Date().toISOString().split('T')[0]}">${!isEdit ? `<button onclick="App.openImportRouteModal()" class="w-full bg-brand-light text-brand-dark py-2 rounded-lg border border-brand-dark border-dashed font-bold text-sm"><i class="fa-solid fa-folder-open mr-1"></i> å¾è¦åŠƒä¸­åŒ¯å…¥ (Import Plan)</button>` : ''}<div class="grid grid-cols-2 gap-3"><input type="text" id="log-start" class="input-field" placeholder="èµ·é»" value="${data.start || ''}"><input type="text" id="log-end" class="input-field" placeholder="çµ‚é»" value="${data.end || ''}"></div><div class="relative"><input type="number" id="log-km" class="input-field pr-24 font-num" placeholder="ä»Šæ—¥é‡Œç¨‹" inputmode="decimal" value="${data.km || ''}"><button onclick="MapPicker.open('log-km')" class="absolute right-2 top-2 text-white bg-brand-dark text-xs px-3 py-2 rounded-lg font-bold shadow-sm flex items-center gap-1"><i class="fa-solid fa-map"></i> æ¸¬è·</button></div><div class="bg-gray-50 p-3 rounded-xl border border-gray-100"><div class="flex justify-between items-center mb-2"><label class="text-xs font-bold text-gray-500">ç•¶æ—¥é–‹éŠ· (ä¸å«ä½å®¿)</label><button onclick="App.addExpenseRow()" class="text-xs bg-brand-dark text-white px-2 py-1 rounded">æ–°å¢</button></div><div id="expense-container" class="space-y-2"></div>${stayCost > 0 ? `<div class="text-xs text-blue-600 mt-2 text-right">ä½å®¿è²» $${stayCost} (è‡ªå‹•å¸¶å…¥)</div>` : ''}</div><div class="flex justify-between gap-2">${['good','normal','bad'].map(m => `<label class="flex-1 cursor-pointer"><input type="radio" name="log-mood" value="${m}" class="peer hidden" ${data.mood === m || (!data.mood && m==='good') ? 'checked' : ''}><div class="text-center py-2 border rounded-xl peer-checked:bg-brand-dark peer-checked:text-white transition text-xl">${m==='good'?'ğŸ˜„':m==='normal'?'ğŸ˜':'ğŸ˜«'}</div></label>`).join('')}</div><textarea id="log-note" class="input-field h-24" placeholder="å¿ƒå¾—...">${data.note || ''}</textarea><button onclick="App.submitLog(${editId})" class="w-full bg-brand-dark text-white py-3 rounded-xl font-bold shadow-lg mt-2">${isEdit ? 'æ›´æ–°' : 'å„²å­˜'}</button>${isEdit ? `<button onclick="App.deleteLog(${editId})" class="w-full text-red-400 text-sm mt-3">åˆªé™¤</button>` : ''}</div>`; 
                this.showModal(isEdit ? 'ç·¨è¼¯æ—¥è¨˜' : 'æ–°å¢æ—¥è¨˜', formHtml); const exContainer = document.getElementById('expense-container'); if(data.expenses && data.expenses.length > 0) data.expenses.forEach(e => this.addExpenseRow(e.name, e.price)); else this.addExpenseRow();
            },
            openRouteModal(editId = null) {
                const isEdit = editId !== null; let data = {}; if(isEdit) data = this.data.routes.find(r => r.id === editId);
                const formHtml = `<div class="space-y-4"><div class="flex gap-2"><input type="number" id="route-day" class="input-field w-1/3 font-num" placeholder="Day" value="${data.dayNum || ''}"><input type="date" id="route-date" class="input-field w-2/3 font-num" value="${data.date || ''}"></div><div class="grid grid-cols-2 gap-3"><input type="text" id="route-start" class="input-field" placeholder="èµ·é»" value="${data.start || ''}"><input type="text" id="route-end" class="input-field" placeholder="çµ‚é»" value="${data.end || ''}"></div><div class="relative"><input type="number" id="route-km" class="input-field pr-24 font-num" placeholder="é ä¼° km" value="${data.estKm || ''}"><button onclick="MapPicker.open('route-km')" class="absolute right-2 top-2 text-white bg-brand-dark text-xs px-3 py-2 rounded-lg font-bold shadow-sm flex items-center gap-1"><i class="fa-solid fa-map"></i> æ¸¬è·</button></div><input type="text" id="route-note" class="input-field" placeholder="å‚™è¨»" value="${data.note || ''}"><button onclick="App.submitRoute(${editId})" class="w-full bg-brand-dark text-white py-3 rounded-xl font-bold shadow-lg mt-2">${isEdit ? 'æ›´æ–°' : 'æ–°å¢'}</button>${isEdit ? `<button onclick="App.deleteRoute(${editId})" class="w-full text-red-400 text-sm mt-3">åˆªé™¤</button>` : ''}</div>`;
                this.showModal(isEdit ? 'ç·¨è¼¯è¦åŠƒ' : 'æ–°å¢è¦åŠƒ', formHtml);
            },
            openStayModal(editId = null) {
                const isEdit = editId !== null; let data = {}; if(isEdit) data = this.data.stays.find(s => s.id === editId);
                const formHtml = `<div class="space-y-4"><input type="date" id="stay-date" class="input-field font-num" value="${data.date || ''}"><input type="text" id="stay-name" class="input-field" placeholder="ä½å®¿åç¨±" value="${data.name || ''}"><div class="grid grid-cols-2 gap-3"><select id="stay-type" class="input-field">${['æ°‘å®¿','é’æ—…','æ—…é¤¨','å€Ÿå®¿','é‡å®¿'].map(t => `<option value="${t}" ${data.type===t?'selected':''}>${t}</option>`).join('')}</select><input type="number" id="stay-price" class="input-field font-num" placeholder="åƒ¹æ ¼" inputmode="numeric" value="${data.price || ''}"></div><input type="tel" id="stay-contact" class="input-field font-num" placeholder="é›»è©±" value="${data.contact || ''}"><div class="text-[10px] text-gray-500 bg-gray-50 p-2 rounded">å‚™è¨»ï¼šè«‹æ‰‹å‹•è²¼ä¸Š Google Maps åˆ†äº«é€£çµ (ç„¡æ³•è‡ªå‹•å¸¶å…¥è³‡æ–™)ã€‚</div><input type="text" id="stay-map" class="input-field" placeholder="Google Map åˆ†äº«é€£çµ" value="${data.mapLink || ''}"><input type="text" id="stay-note" class="input-field" placeholder="å‚™è¨» (æ’åº§ã€æ´—è¡£æ©Ÿ...)" value="${data.note || ''}"><button onclick="App.submitStay(${editId})" class="w-full bg-brand-dark text-white py-3 rounded-xl font-bold shadow-lg mt-2">${isEdit ? 'æ›´æ–°' : 'å„²å­˜'}</button>${isEdit ? `<button onclick="App.deleteStay(${editId})" class="w-full text-red-400 text-sm mt-3">åˆªé™¤</button>` : ''}</div>`;
                this.showModal(isEdit?'ç·¨è¼¯ä½å®¿':'æ–°å¢ä½å®¿', formHtml);
            },
            openGearAdd() { this.showModal('æ–°å¢è£å‚™', `<div class="space-y-4"><input type="text" id="gear-name" class="input-field" placeholder="è£å‚™åç¨±"><select id="gear-cat" class="input-field"><option value="clothing">è¡£ç‰©</option><option value="elec">é›»å­</option><option value="med">é†«è—¥</option><option value="other">å…¶ä»–</option></select><button onclick="App.submitGear()" class="w-full bg-brand-dark text-white py-3 rounded-xl font-bold">æ–°å¢</button></div>`); },
            openHealthModal() { this.showModal('å¥åº·è¿½è¹¤', `<div class="space-y-4"><input type="date" id="h-date" class="input-field font-num" value="${new Date().toISOString().split('T')[0]}"><div class="flex gap-2"><label class="flex-1 cursor-pointer"><input type="radio" name="h-cond" value="good" class="peer hidden" checked><div class="text-center py-2 border rounded peer-checked:bg-brand-dark peer-checked:text-white">ä½³</div></label><label class="flex-1 cursor-pointer"><input type="radio" name="h-cond" value="avg" class="peer hidden"><div class="text-center py-2 border rounded peer-checked:bg-brand-earth peer-checked:text-white">æ™®</div></label><label class="flex-1 cursor-pointer"><input type="radio" name="h-cond" value="bad" class="peer hidden"><div class="text-center py-2 border rounded peer-checked:bg-brand-accent peer-checked:text-white">å·®</div></label></div><input type="number" id="h-sleep" class="input-field" placeholder="ç¡çœ æ™‚æ•¸"><input type="text" id="h-pain" class="input-field" placeholder="ç–¼ç—›éƒ¨ä½"><input type="text" id="h-note" class="input-field" placeholder="å‚™è¨»"><button onclick="App.submitHealth()" class="w-full bg-brand-dark text-white py-3 rounded-xl font-bold">ç´€éŒ„</button></div>`); },
            
            // CRUD
            openImportRouteModal() { if (this.data.routes.length === 0) return alert('ç„¡è¦åŠƒè·¯ç·š'); document.getElementById('import-modal').classList.remove('hidden'); const list = document.getElementById('import-list'); list.innerHTML = ''; this.data.routes.forEach(r => { list.innerHTML += `<div onclick="App.fillLogFromRoute(${r.id})" class="p-3 border rounded-lg hover:bg-brand-light cursor-pointer transition"><div class="flex justify-between font-bold text-sm text-brand-dark"><span>${r.start} â†’ ${r.end}</span> <span>${r.estKm} km</span></div><div class="text-xs text-gray-400 mt-1">${Utils.formatDate(r.date)} (Day ${r.dayNum})</div></div>`; }); },
            fillLogFromRoute(rid) { const r = this.data.routes.find(x => x.id === rid); if(r) { document.getElementById('log-start').value = r.start; document.getElementById('log-end').value = r.end; document.getElementById('log-km').value = r.estKm; document.getElementById('log-note').value = r.note || ''; if(r.coords) window.tempMapCoords = r.coords; } this.closeImportModal(); },
            addExpenseRow(name = '', price = '') { const div = document.createElement('div'); div.className = 'flex gap-2 expense-row'; div.innerHTML = `<input type="text" class="input-field py-1 text-sm flex-[2] ex-name" placeholder="é …ç›®" value="${name}"><input type="number" class="input-field py-1 text-sm flex-1 ex-price" placeholder="$" value="${price}"><button onclick="this.parentElement.remove()" class="text-gray-400 px-1"><i class="fa-solid fa-xmark"></i></button>`; document.getElementById('expense-container').appendChild(div); },
            submitLog(editId) { const expenses = []; document.querySelectorAll('.expense-row').forEach(row => { const name = row.querySelector('.ex-name').value; const price = row.querySelector('.ex-price').value; if(name && price) expenses.push({name, price}); }); const newLog = { id: editId || Date.now(), date: document.getElementById('log-date').value, start: document.getElementById('log-start').value, end: document.getElementById('log-end').value, km: document.getElementById('log-km').value, expenses: expenses, mood: document.querySelector('input[name="log-mood"]:checked').value, note: document.getElementById('log-note').value, coords: window.tempMapCoords || (editId ? this.data.logs.find(l=>l.id===editId).coords : null) }; if (editId) { const idx = this.data.logs.findIndex(l => l.id === editId); this.data.logs[idx] = newLog; } else { this.data.logs.unshift(newLog); } window.tempMapCoords = null; this.saveData(); this.closeModal(); this.router('log'); },
            deleteLog(id) { if(confirm('åˆªé™¤?')) { this.data.logs = this.data.logs.filter(l => l.id !== id); this.saveData(); this.closeModal(); this.router('log'); }},
            submitRoute(editId) { const newRoute={id:editId||Date.now(),dayNum:document.getElementById('route-day').value,date:document.getElementById('route-date').value,start:document.getElementById('route-start').value,end:document.getElementById('route-end').value,estKm:document.getElementById('route-km').value,note:document.getElementById('route-note').value,coords:window.tempMapCoords||(editId?this.data.routes.find(r=>r.id===editId).coords:null)}; if(editId){const idx=this.data.routes.findIndex(r=>r.id===editId);this.data.routes[idx]=newRoute;}else{this.data.routes.push(newRoute);}window.tempMapCoords=null;this.saveData();this.closeModal();this.router('route'); },
            deleteRoute(id) { if(confirm('åˆªé™¤?')) { this.data.routes = this.data.routes.filter(r => r.id !== id); this.saveData(); this.closeModal(); this.router('route'); }},
            submitStay(editId) { const newStay = { id: editId || Date.now(), date: document.getElementById('stay-date').value, name: document.getElementById('stay-name').value, type: document.getElementById('stay-type').value, price: document.getElementById('stay-price').value, contact: document.getElementById('stay-contact').value, mapLink: document.getElementById('stay-map').value, note: document.getElementById('stay-note').value }; if(editId) { const idx = this.data.stays.findIndex(s => s.id === editId); this.data.stays[idx] = newStay; } else { this.data.stays.push(newStay); } this.saveData(); this.closeModal(); this.router('stay'); },
            deleteStay(id) { if(confirm('åˆªé™¤?')) { this.data.stays = this.data.stays.filter(s => s.id !== id); this.saveData(); this.closeModal(); this.router('stay'); }},
            submitGear() { this.data.gears.push({id:Date.now(),name:document.getElementById('gear-name').value,cat:document.getElementById('gear-cat').value,checked:false});this.saveData();this.closeModal();this.router('gear'); },
            deleteGear(id) { if(confirm('åˆªé™¤?')) { this.data.gears = this.data.gears.filter(g=>g.id!==id);this.saveData();this.router('gear'); }},
            submitHealth() { this.data.health.push({ id: Date.now(), date: document.getElementById('h-date').value, condition: document.querySelector('input[name="h-cond"]:checked').value, sleep: document.getElementById('h-sleep').value, pain: document.getElementById('h-pain').value, note: document.getElementById('h-note').value }); this.saveData(); this.closeModal(); this.router('stats'); },
            seedGearData() { this.data.gears=[{id:1,name:'æ’æ±—è¡« x3',cat:'clothing',checked:false},{id:2,name:'é›¨è¡£',cat:'clothing',checked:false},{id:3,name:'è¡Œå‹•é›»æº',cat:'elec',checked:false},{id:4,name:'å……é›»ç·š',cat:'elec',checked:false},{id:5,name:'ç— ç—›è²¼å¸ƒ',cat:'med',checked:false}];this.saveData(); },
            filterGear(c) { const el=document.getElementById('gear-list');el.innerHTML='';const f=c==='all'?this.data.gears:this.data.gears.filter(g=>g.cat===c);if(f.length===0){el.innerHTML='<div class="text-center text-gray-300 py-10">ç„¡é …ç›®</div>';return;}f.forEach(i=>el.innerHTML+=`<div class="card p-3 flex justify-between items-center"><div class="flex items-center flex-1" onclick="App.toggleGear(${i.id})"><i class="fa-regular ${i.checked?'fa-square-check text-brand-dark':'fa-square text-gray-300'} text-xl mr-3 cursor-pointer"></i><span class="${i.checked?'text-gray-400 line-through':'text-brand-dark font-medium'}">${i.name}</span></div><button onclick="App.deleteGear(${i.id})" class="text-gray-200 px-2 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></div>`); },
            toggleGear(id) { const g=this.data.gears.find(i=>i.id===id);if(g){g.checked=!g.checked;this.saveData();this.router('gear'); }},
            closeImportModal() { document.getElementById('import-modal').classList.add('hidden'); }
        };

        document.addEventListener('DOMContentLoaded', () => { App.init(); });
    </script>
</body>
</html>
