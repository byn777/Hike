<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>徒步環島紀錄 v6 | Island Walker</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { bg: '#FDFCF8', dark: '#2C5E50', light: '#E8F5E9', earth: '#A39274', accent: '#E76F51', text: '#333333' }
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'], num: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #FDFCF8; color: #333; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); }
        .input-field { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #E5E7EB; background: #FAFAFA; outline: none; transition: 0.2s; font-size: 16px; }
        .input-field:focus { border-color: #2C5E50; background: white; }
        .fab { position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background-color: #2C5E50; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(44, 94, 80, 0.4); font-size: 24px; z-index: 50; cursor: pointer; }
        .nav-item.active { color: #2C5E50; } .nav-item { color: #A8A29E; transition: 0.3s; }
        #map-picker-container { height: 100%; width: 100%; z-index: 10; }
        .custom-pin { text-align: center; }
        .pin-number { background: #2C5E50; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; line-height: 24px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); font-weight: bold; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden font-sans">

    <!-- Header -->
    <header class="flex-none bg-brand-bg px-5 py-4 flex justify-between items-center shadow-sm z-10 border-b border-gray-100">
        <h1 class="text-xl font-bold text-brand-dark tracking-wide flex items-center"><i class="fa-solid fa-person-hiking mr-2"></i>Island Walker</h1>
        <div id="total-stats" class="text-xs font-bold font-num text-brand-earth bg-brand-light px-3 py-1 rounded-full border border-brand-earth/20">Loading...</div>
    </header>

    <!-- Main -->
    <main id="app-container" class="flex-1 overflow-y-auto no-scrollbar p-5 pb-24 scroll-smooth relative"></main>

    <!-- Nav -->
    <nav class="flex-none bg-white border-t border-gray-100 pb-safe flex justify-around items-center h-20 fixed bottom-0 w-full z-[60]">
        <button onclick="App.router('log')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-log"><i class="fa-solid fa-shoe-prints text-xl mb-1"></i><span class="text-[10px] font-medium">紀錄</span></button>
        <button onclick="App.router('route')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-route"><i class="fa-solid fa-map-location-dot text-xl mb-1"></i><span class="text-[10px] font-medium">規劃</span></button>
        <button onclick="App.router('stay')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-stay"><i class="fa-solid fa-bed text-xl mb-1"></i><span class="text-[10px] font-medium">住宿</span></button>
        <button onclick="App.router('gear')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-gear"><i class="fa-solid fa-suitcase text-xl mb-1"></i><span class="text-[10px] font-medium">裝備</span></button>
        <button onclick="App.router('stats')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-stats"><i class="fa-solid fa-chart-pie text-xl mb-1"></i><span class="text-[10px] font-medium">統計</span></button>
    </nav>

    <!-- Generic Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-5 shadow-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-none border-b pb-3">
                <h3 id="modal-title" class="text-lg font-bold text-brand-dark">標題</h3>
                <button onclick="App.closeModal()" class="text-gray-400 hover:text-gray-600 px-2"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="modal-content" class="flex-1 overflow-y-auto no-scrollbar space-y-4"></div>
        </div>
    </div>

    <!-- Route Import Modal -->
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-5 shadow-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-none border-b pb-3">
                <h3 class="text-lg font-bold text-brand-dark">選擇規劃路線匯入</h3>
                <button onclick="App.closeImportModal()" class="text-gray-400 px-2"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="import-list" class="flex-1 overflow-y-auto space-y-3"></div>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="map-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[90] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl h-[95vh] flex flex-col overflow-hidden">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center flex-none">
                <h3 class="font-bold text-brand-dark text-sm flex items-center gap-2"><i class="fa-solid fa-person-walking text-brand-dark"></i> 測距 (OSM)</h3>
                <button onclick="App.closeMapModal()" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-3 bg-white flex-none max-h-[30vh] overflow-y-auto border-b">
                <div class="text-[10px] text-red-500 mb-2 bg-red-50 p-2 rounded border border-red-100 font-bold">
                    <i class="fa-solid fa-triangle-exclamation"></i> 警告：系統可能誤排快速道路，請僅作距離估算，實際行走請務必遵守交通規則並使用 Google Maps 確認路況。
                </div>
                <div id="stops-list" class="space-y-2"></div>
                <button onclick="MapPicker.addStopInput()" class="mt-2 text-xs font-bold text-brand-dark flex items-center gap-1 hover:bg-gray-100 px-2 py-1 rounded"><i class="fa-solid fa-plus-circle"></i> 增加途經點</button>
            </div>
            <div class="p-2 flex gap-2 items-center bg-white border-b flex-none z-10 shadow-sm">
                <button onclick="MapPicker.processInputs()" class="flex-1 bg-brand-dark text-white py-2 rounded-lg font-bold text-sm shadow"><i class="fa-solid fa-calculator mr-1"></i> 計算路徑</button>
                <div class="flex-1 text-right pr-2"><div class="text-xs text-gray-500">估計距離</div><div class="text-lg font-bold text-brand-accent font-num" id="map-result-text">0.0 km</div></div>
            </div>
            <div class="flex-1 relative bg-gray-100">
                <div id="map-picker-container"></div>
                <div class="absolute bottom-4 left-4 right-4 z-[999]"><button onclick="MapPicker.confirm()" id="btn-map-confirm" disabled class="w-full bg-brand-accent text-white py-3 rounded-xl font-bold shadow-lg disabled:opacity-50 disabled:translate-y-20 transition-all transform">確認並帶入</button></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const Utils = {
            weekDays: ['週日', '週一', '週二', '週三', '週四', '週五', '週六'],
            formatDate(dateStr) { if(!dateStr) return ''; const d = new Date(dateStr); return `${dateStr} ${this.weekDays[d.getDay()]}`; },
            getMidnight(dateStr) { const d = new Date(dateStr); d.setHours(0,0,0,0); return d; }
        };

        const MapPicker = {
            map: null, stops: [], polyline: null, targetInputId: null, calculatedKm: 0,
            init() { if (this.map) return; this.map = L.map('map-picker-container', { zoomControl: false }).setView([23.58, 120.58], 7); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OSM' }).addTo(this.map); if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(pos => { this.map.setView([pos.coords.latitude, pos.coords.longitude], 12); }); } },
            open(inputId) { this.targetInputId = inputId; document.getElementById('map-modal').classList.remove('hidden'); setTimeout(() => { this.init(); this.map.invalidateSize(); }, 100); if(this.stops.length === 0) this.reset(); else this.cleanMapLayers(); },
            reset() { this.stops = []; document.getElementById('stops-list').innerHTML = ''; this.addStopInput('起點 (ex: 台北車站)'); this.addStopInput('終點 (ex: 7-11 羅東)'); this.cleanMapLayers(); },
            cleanMapLayers() { if(this.polyline) this.map.removeLayer(this.polyline); this.stops.forEach(s => { if(s.marker) this.map.removeLayer(s.marker); s.coords = null; s.marker = null; }); this.calculatedKm = 0; document.getElementById('map-result-text').innerText = '0.0 km'; document.getElementById('btn-map-confirm').disabled = true; },
            addStopInput(placeholder = '途經點') { const id = Date.now() + Math.random(); const stop = { id, text: '', coords: null, marker: null }; this.stops.push(stop); this.renderStopList(); },
            removeStop(id) { if(this.stops.length <= 2) return alert('至少需要起點和終點'); const idx = this.stops.findIndex(s => s.id === id); if(this.stops[idx].marker) this.map.removeLayer(this.stops[idx].marker); this.stops = this.stops.filter(s => s.id !== id); this.renderStopList(); this.cleanMapLayers(); },
            renderStopList() { const container = document.getElementById('stops-list'); container.innerHTML = ''; this.stops.forEach((stop, index) => { const isStart = index === 0; const isEnd = index === this.stops.length - 1; const label = isStart ? '起' : isEnd ? '終' : (index); const colorClass = isStart ? 'bg-brand-dark' : isEnd ? 'bg-brand-accent' : 'bg-gray-400'; const div = document.createElement('div'); div.className = 'flex items-center gap-2 animate-[fadeIn_0.2s]'; div.innerHTML = `<div class="flex-none w-6 h-6 rounded-full ${colorClass} text-white text-xs font-bold flex items-center justify-center">${label}</div><input type="text" class="flex-1 bg-gray-100 rounded-lg px-3 py-2 text-sm border border-transparent focus:bg-white focus:border-brand-dark outline-none transition" placeholder="${isStart?'輸入起點...':isEnd?'輸入終點...':'輸入途經點...'}" value="${stop.text}">${this.stops.length > 2 ? `<button onclick="MapPicker.removeStop(${stop.id})" class="text-gray-300 hover:text-red-400 px-1"><i class="fa-solid fa-xmark"></i></button>` : ''}`; div.querySelector('input').addEventListener('input', (e) => stop.text = e.target.value); container.appendChild(div); }); },
            async processInputs() {
                const inputs = this.stops.filter(s => s.text.trim() !== ''); if (inputs.length < 2) return alert('請至少輸入起點和終點');
                document.getElementById('map-result-text').innerText = '定位中...'; this.stops.forEach(s => { if(s.marker) this.map.removeLayer(s.marker); });
                for (let i = 0; i < inputs.length; i++) {
                    const stop = inputs[i];
                    try { const coords = await this.smartGeocode(stop.text); if (coords) { stop.coords = coords; this.addMarker(stop, i); } else { alert(`找不到: ${stop.text}`); document.getElementById('map-result-text').innerText = '定位失敗'; return; } await new Promise(r => setTimeout(r, 600)); } catch (e) { alert('網路錯誤'); return; }
                } this.calculateRoute();
            },
            async smartGeocode(query) { let res = await this.geocode(query); if (res) return res; const noZip = query.replace(/^\d{3,5}/, '').trim(); if (noZip !== query) { res = await this.geocode(noZip); if (res) return res; } const noHouse = noZip.replace(/\d+(號|F|樓|f).*/, '').trim(); if (noHouse !== noZip && noHouse.length > 1) { res = await this.geocode(noHouse); if (res) return res; } return null; },
            async geocode(query) { try { const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`; const res = await fetch(url); const data = await res.json(); if (data && data.length > 0) return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) }; } catch(e) { return null; } return null; },
            addMarker(stop, index) { const label = (index + 1).toString(); const html = `<div class="pin-number">${label}</div>`; const icon = L.divIcon({ className: 'custom-pin', html: html, iconSize: [24, 24] }); const marker = L.marker([stop.coords.lat, stop.coords.lng], { icon: icon, draggable: true }).addTo(this.map); marker.on('dragend', (e) => { stop.coords = e.target.getLatLng(); this.calculateRoute(); }); stop.marker = marker; },
            async calculateRoute() {
                const activeStops = this.stops.filter(s => s.coords); if (activeStops.length < 2) return;
                document.getElementById('map-result-text').innerText = '估算中...';
                const coordString = activeStops.map(s => `${s.coords.lng},${s.coords.lat}`).join(';');
                try { const res = await fetch(`https://router.project-osrm.org/route/v1/foot/${coordString}?overview=full&geometries=geojson`); const data = await res.json();
                    if (data.code === 'Ok' && data.routes.length > 0) { const route = data.routes[0]; this.calculatedKm = (route.distance / 1000).toFixed(2); document.getElementById('map-result-text').innerText = `${this.calculatedKm} km`; document.getElementById('btn-map-confirm').disabled = false;
                        if (this.polyline) this.map.removeLayer(this.polyline); const latlngs = route.geometry.coordinates.map(c => [c[1], c[0]]); this.polyline = L.polyline(latlngs, { color: '#ef4444', weight: 4, opacity: 0.7, dashArray: '10, 10' }).addTo(this.map); this.map.fitBounds(this.polyline.getBounds(), { padding: [50, 50] }); }
                } catch (e) { document.getElementById('map-result-text').innerText = '計算失敗'; }
            },
            confirm() { if (this.targetInputId) document.getElementById(this.targetInputId).value = this.calculatedKm; const active = this.stops.filter(s => s.coords); if(active.length >= 2) { window.tempMapCoords = { start: active[0].coords, end: active[active.length-1].coords, waypoints: active.slice(1, -1).map(s => s.coords) }; const startInput = document.getElementById(this.targetInputId.replace('km', 'start')); const endInput = document.getElementById(this.targetInputId.replace('km', 'end')); if(startInput && !startInput.value) startInput.value = active[0].text; if(endInput && !endInput.value) endInput.value = active[active.length-1].text; } App.closeMapModal(); }
        };

        const App = {
            data: { logs: [], routes: [], stays: [], gears: [], health: [], targetKm: 1200 },
            currentView: 'log', firstDate: null, chartInstance: null,
            init() { this.loadData(); this.router('log'); if(this.data.gears.length === 0) this.seedGearData(); window.App = this; window.MapPicker = MapPicker; },
            loadData() { const stored = localStorage.getItem('island_walker_v6_db'); if (stored) this.data = JSON.parse(stored); else if (localStorage.getItem('island_walker_v5_db')) { this.data = JSON.parse(localStorage.getItem('island_walker_v5_db')); this.data.targetKm = 1200; this.saveData(); } },
            saveData() { localStorage.setItem('island_walker_v6_db', JSON.stringify(this.data)); this.calculateFirstDate(); this.updateGlobalStats(); },
            calculateFirstDate() { if (this.data.logs.length > 0) { const sorted = [...this.data.logs].sort((a,b) => new Date(a.date) - new Date(b.date)); this.firstDate = sorted[0].date; } else { this.firstDate = null; } },
            getDayNumber(dateStr) { if (!this.firstDate) return 1; const start = Utils.getMidnight(this.firstDate); const current = Utils.getMidnight(dateStr); const diffTime = current - start; return Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1; },
            updateGlobalStats() { const totalKm = this.data.logs.reduce((acc, curr) => acc + Number(curr.km || 0), 0); const today = new Date().toISOString().split('T')[0]; const dayText = this.firstDate ? `Day ${this.getDayNumber(today)}` : '未開始'; document.getElementById('total-stats').innerText = `${dayText} • 累積 ${totalKm.toFixed(1)} km`; },
            router(view) { this.currentView = view; document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); document.getElementById(`nav-${view}`).classList.add('active'); const container = document.getElementById('app-container'); window.scrollTo(0, 0); switch(view) { case 'log': this.renderLogView(container); break; case 'route': this.renderRouteView(container); break; case 'stay': this.renderStayView(container); break; case 'gear': this.renderGearView(container); break; case 'stats': this.renderStatsView(container); break; } this.updateGlobalStats(); },

            renderStatsView(container) {
                const totalKm = this.data.logs.reduce((acc, c) => acc + Number(c.km||0), 0);
                const progress = Math.min((totalKm / this.data.targetKm) * 100, 100).toFixed(1);
                let stayTotal = 0, foodTotal = 0;
                this.data.logs.forEach(l => { stayTotal += this.getStayCostByDate(l.date); if(l.expenses) { l.expenses.forEach(e => foodTotal += Number(e.price)); } else if(l.otherCost) foodTotal += Number(l.otherCost); });
                const totalCost = stayTotal + foodTotal;
                container.innerHTML = `
                    <div class="space-y-6 animate-[fadeIn_0.3s]">
                        <div class="card p-5 bg-gradient-to-br from-brand-dark to-[#1a4036] text-white relative overflow-hidden"><i class="fa-solid fa-person-hiking absolute -right-4 -bottom-4 text-8xl text-white opacity-10"></i><div class="flex justify-between items-end mb-2"><div><h3 class="text-sm opacity-80">環島進度</h3><div class="text-3xl font-bold font-num">${totalKm.toFixed(1)} <span class="text-sm">km</span></div></div><div class="text-right"><div class="text-sm opacity-80">目標</div><div class="text-xl font-bold font-num" onclick="App.editTarget()">${this.data.targetKm} <i class="fa-solid fa-pen text-xs opacity-50"></i></div></div></div><div class="w-full bg-white/20 rounded-full h-3 mb-1"><div class="bg-brand-accent h-3 rounded-full transition-all duration-1000" style="width: ${progress}%"></div></div><div class="text-right text-xs font-bold">${progress}% 完成</div></div>
                        <div class="card p-5"><h3 class="font-bold text-brand-dark mb-4 border-b pb-2">花費分析 ($${totalCost})</h3><div class="h-48 relative"><canvas id="expenseChart"></canvas></div></div>
                        <div class="flex justify-between items-center mt-6 mb-2"><h3 class="font-bold text-gray-500">健康狀態紀錄</h3><button onclick="App.openHealthModal()" class="text-xs bg-brand-dark text-white px-3 py-1.5 rounded-full shadow"><i class="fa-solid fa-plus"></i> 新增狀態</button></div>
                        <div id="health-list" class="space-y-3 pb-10"></div>
                    </div>
                `;
                setTimeout(() => { const ctx = document.getElementById('expenseChart'); if(ctx) { new Chart(ctx, { type: 'doughnut', data: { labels: ['住宿', '飲食/雜支'], datasets: [{ data: [stayTotal, foodTotal], backgroundColor: ['#2C5E50', '#E76F51'], borderWidth: 0 }] }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } }); } }, 100);
                const healthContainer = document.getElementById('health-list'); if (this.data.health.length === 0) healthContainer.innerHTML = `<div class="text-center text-gray-300 py-4">無健康紀錄</div>`; else { this.data.health.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(h => { healthContainer.innerHTML += `<div class="card p-3 border-l-4 ${h.condition==='good'?'border-green-500':h.condition==='bad'?'border-red-500':'border-gray-400'}"><div class="flex justify-between text-xs mb-1"><span class="font-bold text-gray-600">${Utils.formatDate(h.date)}</span><span class="${h.condition==='good'?'text-green-600':'text-red-500'} font-bold">${h.condition==='good'?'良好':h.condition==='bad'?'需休息':'普通'}</span></div><div class="text-sm">睡眠 ${h.sleep}h ${h.pain?`• 痛: ${h.pain}`:''}</div>${h.note?`<div class="text-xs text-gray-500 mt-1 bg-gray-50 p-1 rounded">${h.note}</div>`:''}</div>`; }); }
            },
            editTarget() { const newT = prompt('設定目標公里數', this.data.targetKm); if(newT && !isNaN(newT)) { this.data.targetKm = Number(newT); this.saveData(); this.router('stats'); } },

            renderLogView(container) {
                let html = ''; if (this.data.logs.length === 0) html += `<div class="flex flex-col items-center justify-center h-[60vh] text-gray-300"><i class="fa-solid fa-person-hiking text-6xl mb-4"></i><p>開始紀錄你的第一天</p></div>`; else { const sortedLogs = [...this.data.logs].sort((a,b) => new Date(b.date) - new Date(a.date)); sortedLogs.forEach(log => { const dayNum = this.getDayNumber(log.date); const stayCost = this.getStayCostByDate(log.date); const expenses = log.expenses || []; const totalCost = expenses.reduce((acc, curr) => acc + Number(curr.price), 0) + stayCost; let exHtml = ''; if(expenses.length > 0 || stayCost > 0) { exHtml = `<div class="mt-2 pt-2 border-t border-gray-100 text-xs text-gray-500 space-y-1">`; expenses.forEach(e => exHtml += `<div class="flex justify-between"><span>${e.name}</span><span>$${e.price}</span></div>`); if(stayCost > 0) exHtml += `<div class="flex justify-between text-blue-600"><span>住宿費</span><span>$${stayCost}</span></div>`; exHtml += `</div>`; } html += `<div class="card p-5 mb-5 border-l-[6px] border-brand-dark"><div class="flex justify-between items-start mb-3"><div><div class="text-xs font-bold font-num text-white bg-brand-earth px-2 py-1 rounded inline-block mb-1">Day ${dayNum}</div><div class="text-xs text-gray-400 font-num">${Utils.formatDate(log.date)}</div></div><button onclick="App.openLogModal(${log.id})" class="text-gray-300 p-2"><i class="fa-solid fa-pen-to-square"></i></button></div><h3 class="text-xl font-bold text-brand-dark mb-1 flex items-center">${log.start} <i class="fa-solid fa-arrow-right-long text-sm mx-2 text-gray-300"></i> ${log.end}</h3><div class="grid grid-cols-2 gap-3 my-3"><div class="bg-gray-50 p-2 rounded-lg"><div class="text-xs text-gray-400">里程</div><div class="font-bold te