<!DOCTYPE html>
<html lang="zh-TW" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¾’æ­¥ç’°å³¶ç´€éŒ„ v17</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class', // Enable Dark Mode
            theme: {
                extend: {
                    colors: {
                        brand: { 
                            bg: '#FDFCF8', 
                            dark: '#2C5E50', 
                            light: '#E8F5E9', 
                            earth: '#A39274', 
                            accent: '#E76F51', 
                            text: '#333333' 
                        }
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'], num: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Light/Dark Base Styles */
        body { background-color: #FDFCF8; color: #333; transition: background-color 0.3s, color 0.3s; }
        .dark body { background-color: #111827; color: #E5E7EB; }

        /* Card Styles */
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); transition: background-color 0.3s; }
        .dark .card { background: #1F2937; box-shadow: none; border: 1px solid #374151; }

        /* Input Styles */
        .input-field { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #E5E7EB; background: #FAFAFA; outline: none; transition: 0.2s; font-size: 16px; }
        .input-field:focus { border-color: #2C5E50; background: white; }
        .dark .input-field { background: #374151; border-color: #4B5563; color: white; }
        .dark .input-field:focus { border-color: #10B981; background: #1F2937; }

        /* Navigation */
        .nav-item.active { color: #2C5E50; } 
        .dark .nav-item.active { color: #10B981; }
        .nav-item { color: #A8A29E; transition: 0.3s; }
        .dark .nav-item { color: #6B7280; }

        /* Map Dark Mode Filter */
        .dark .leaflet-layer, .dark .leaflet-control-zoom-in, .dark .leaflet-control-zoom-out, .dark .leaflet-control-attribution { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }

        /* Calendar Styles */
        .cal-cell { min-height: 80px; border-radius: 8px; font-size: 12px; position: relative; cursor: pointer; transition: 0.1s; border: 1px solid #f3f4f6; display: flex; flex-direction: column; padding: 2px; align-items: center; justify-content: flex-start; overflow: hidden; }
        .dark .cal-cell { border-color: #374151; }
        .cal-cell:active { transform: scale(0.98); background: #f3f4f6; }
        .dark .cal-cell:active { background: #374151; }
        .cal-today { border: 2px solid #2C5E50; }
        .dark .cal-today { border-color: #10B981; }

        .fab { position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background-color: #2C5E50; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(44, 94, 80, 0.4); font-size: 24px; z-index: 50; cursor: pointer; }
        .dark .fab { background-color: #10B981; color: #064E3B; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden font-sans">

    <!-- Header -->
    <header class="flex-none bg-brand-bg dark:bg-gray-900 px-5 py-4 flex justify-between items-center shadow-sm z-10 border-b border-gray-100 dark:border-gray-800 transition-colors">
        <h1 class="text-xl font-bold text-brand-dark dark:text-emerald-400 tracking-wide flex items-center"><i class="fa-solid fa-person-hiking mr-2"></i>Island Walker</h1>
        <div class="flex items-center gap-3">
            <div id="total-stats" class="text-xs font-bold font-num text-brand-earth bg-brand-light dark:bg-gray-800 dark:text-gray-300 px-3 py-1 rounded-full border border-brand-earth/20 dark:border-gray-700">Loading...</div>
            <button onclick="App.toggleTheme()" class="text-gray-400 hover:text-brand-dark dark:hover:text-yellow-400 transition"><i class="fa-solid fa-moon" id="theme-icon"></i></button>
        </div>
    </header>

    <!-- Error Screen -->
    <div id="error-screen" class="hidden fixed inset-0 z-[100] bg-white dark:bg-gray-900 flex flex-col items-center justify-center p-10 text-center">
        <i class="fa-solid fa-triangle-exclamation text-5xl text-red-500 mb-4"></i>
        <h2 class="text-xl font-bold mb-2 dark:text-white">ç™¼ç”ŸéŒ¯èª¤</h2>
        <p id="error-msg" class="text-sm text-gray-500 mb-6 break-all">Unknown Error</p>
        <button onclick="localStorage.clear(); location.reload();" class="bg-red-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg">æ¸…é™¤ä¸¦é‡ç½®</button>
    </div>

    <!-- Main -->
    <main id="app-container" class="flex-1 overflow-y-auto no-scrollbar p-5 pb-24 scroll-smooth relative dark:bg-gray-900 transition-colors"></main>

    <!-- Nav -->
    <nav class="flex-none bg-white dark:bg-gray-800 border-t border-gray-100 dark:border-gray-700 pb-safe flex justify-around items-center h-20 fixed bottom-0 w-full z-[60] transition-colors">
        <button onclick="App.router('log')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-log"><i class="fa-solid fa-book-open text-xl mb-1"></i><span class="text-[10px] font-medium">æ—¥è¨˜</span></button>
        <button onclick="App.router('route')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-route"><i class="fa-solid fa-map-location-dot text-xl mb-1"></i><span class="text-[10px] font-medium">è¦åŠƒ</span></button>
        <button onclick="App.router('stay')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-stay"><i class="fa-solid fa-bed text-xl mb-1"></i><span class="text-[10px] font-medium">ä½å®¿</span></button>
        <button onclick="App.router('gear')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-gear"><i class="fa-solid fa-suitcase text-xl mb-1"></i><span class="text-[10px] font-medium">è£å‚™</span></button>
        <button onclick="App.router('stats')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-stats"><i class="fa-solid fa-chart-pie text-xl mb-1"></i><span class="text-[10px] font-medium">çµ±è¨ˆ</span></button>
    </nav>

    <!-- Generic Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 w-full max-w-md rounded-2xl p-5 shadow-2xl max-h-[90vh] flex flex-col transition-colors">
            <div class="flex justify-between items-center mb-4 flex-none border-b dark:border-gray-700 pb-3">
                <h3 id="modal-title" class="text-lg font-bold text-brand-dark dark:text-emerald-400">æ¨™é¡Œ</h3>
                <button onclick="App.closeModal()" class="text-gray-400 hover:text-gray-600 px-2"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="modal-content" class="flex-1 overflow-y-auto no-scrollbar space-y-4"></div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 w-full max-w-md rounded-2xl p-5 shadow-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-none border-b dark:border-gray-700 pb-3">
                <h3 class="text-lg font-bold text-brand-dark dark:text-emerald-400">é¸æ“‡è¦åŠƒè·¯ç·šåŒ¯å…¥</h3>
                <button onclick="App.closeImportModal()" class="text-gray-400 px-2"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="import-list" class="flex-1 overflow-y-auto space-y-3"></div>
        </div>
    </div>

    <!-- Share Card Modal -->
    <div id="share-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden z-[90] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl relative">
            <button onclick="document.getElementById('share-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 z-10"><i class="fa-solid fa-xmark text-2xl"></i></button>
            <div class="p-8 flex flex-col items-center text-center bg-brand-bg dark:bg-gray-800 border-8 border-white dark:border-gray-700 h-full">
                <div class="mb-4"><i class="fa-solid fa-person-hiking text-6xl text-brand-dark dark:text-emerald-400"></i></div>
                <h2 class="text-2xl font-bold text-brand-dark dark:text-white mb-1">å¾’æ­¥ç’°å³¶ä¸­</h2>
                <div class="text-brand-earth dark:text-gray-400 text-sm font-bold uppercase tracking-widest mb-6">ISLAND WALKER</div>
                
                <div class="grid grid-cols-2 gap-4 w-full mb-6">
                    <div class="bg-white dark:bg-gray-700 p-3 rounded-xl shadow-sm">
                        <div class="text-xs text-gray-400">ç›®å‰ç´¯ç©</div>
                        <div class="text-2xl font-bold text-brand-dark dark:text-emerald-400 font-num" id="share-km">0</div>
                        <div class="text-[10px] text-gray-400">Kilometers</div>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-3 rounded-xl shadow-sm">
                        <div class="text-xs text-gray-400">è¡Œç¨‹å¤©æ•¸</div>
                        <div class="text-2xl font-bold text-brand-accent dark:text-orange-400 font-num" id="share-day">0</div>
                        <div class="text-[10px] text-gray-400">Days</div>
                    </div>
                </div>
                
                <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-4 mb-2 overflow-hidden">
                    <div id="share-bar" class="bg-brand-dark dark:bg-emerald-500 h-4 rounded-full" style="width: 0%"></div>
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mb-8">ç›®æ¨™å®Œæˆåº¦ <span id="share-pct">0%</span></div>
                
                <div class="text-xs text-gray-300 bg-gray-50 dark:bg-gray-900 px-4 py-2 rounded-full">æˆªåœ–åˆ†äº«æ­¤ç•«é¢</div>
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="map-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[90] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 w-full max-w-md rounded-2xl shadow-2xl h-[95vh] flex flex-col overflow-hidden">
            <div class="p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900 flex justify-between items-center flex-none">
                <h3 class="font-bold text-brand-dark dark:text-emerald-400 text-sm flex items-center gap-2"><i class="fa-solid fa-person-walking"></i> æ¸¬è· (OSM)</h3>
                <button onclick="App.closeMapModal()" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-3 bg-white dark:bg-gray-800 flex-none max-h-[30vh] overflow-y-auto border-b dark:border-gray-700">
                <div class="text-[10px] text-gray-500 dark:text-gray-400 mb-2 bg-gray-50 dark:bg-gray-700 p-2 rounded border border-gray-100 dark:border-gray-600">
                    <i class="fa-regular fa-lightbulb"></i> ç³»çµ±æœƒè‡ªå‹•ç°¡åŒ–åœ°å€ä»¥æé«˜æœå°‹æˆåŠŸç‡ã€‚
                </div>
                <div id="stops-list" class="space-y-2"></div>
                <button onclick="MapPicker.addStopInput()" class="mt-2 text-xs font-bold text-brand-dark dark:text-emerald-400 flex items-center gap-1 hover:bg-gray-100 dark:hover:bg-gray-700 px-2 py-1 rounded"><i class="fa-solid fa-plus-circle"></i> å¢åŠ é€”ç¶“é»</button>
            </div>
            <div class="p-2 flex gap-2 items-center bg-white dark:bg-gray-800 border-b dark:border-gray-700 flex-none z-10 shadow-sm">
                <button onclick="MapPicker.processInputs()" class="flex-1 bg-brand-dark dark:bg-emerald-600 text-white py-2 rounded-lg font-bold text-sm shadow"><i class="fa-solid fa-calculator mr-1"></i> è¨ˆç®—è·¯å¾‘</button>
                <div class="flex-1 text-right pr-2"><div class="text-xs text-gray-500 dark:text-gray-400">é ä¼°è·é›¢</div><div class="text-lg font-bold text-brand-accent dark:text-orange-400 font-num" id="map-result-text">0.0 km</div></div>
            </div>
            <div class="flex-1 relative bg-gray-100 dark:bg-gray-900">
                <div id="map-picker-container"></div>
                <div class="absolute bottom-4 left-4 right-4 z-[999]"><button onclick="MapPicker.confirm()" id="btn-map-confirm" disabled class="w-full bg-brand-accent dark:bg-orange-500 text-white py-3 rounded-xl font-bold shadow-lg disabled:opacity-50 disabled:translate-y-20 transition-all transform">ç¢ºèªä¸¦å¸¶å…¥</button></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        window.onerror = function(message, source, lineno, colno, error) { document.getElementById('error-screen').classList.remove('hidden'); document.getElementById('error-msg').innerText = message + " (Line: " + lineno + ")"; };

        const Utils = {
            weekDays: ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'],
            formatDate(dateStr) { if(!dateStr) return ''; const d = new Date(dateStr); return `${dateStr} ${this.weekDays[d.getDay()]}`; },
            getMidnight(dateStr) { const d = new Date(dateStr); d.setHours(0,0,0,0); return d; },
            extractCityDistrict(addr) { if(!addr) return ''; const match = addr.match(/(\d{3,5})?(.+?[ç¸£å¸‚].+?[å¸‚å€é„‰é®])/); return match ? match[2] : addr; },
            renderCardHeader(dayNum, dateStr, btnHtml='') {
                return `<div class="flex justify-between items-start mb-3"><div class="flex flex-col"><span class="text-xs font-bold text-brand-earth dark:text-gray-300 bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded w-max mb-1 font-num">Day ${dayNum}</span><span class="text-xs text-gray-400 dark:text-gray-500 font-num">${Utils.formatDate(dateStr)}</span></div>${btnHtml}</div>`;
            }
        };

        const MapPicker = {
            map: null, stops: [], polyline: null, targetInputId: null, calculatedKm: 0,
            init() { if (this.map) return; this.map = L.map('map-picker-container', { zoomControl: false }).setView([23.58, 120.58], 7); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OSM' }).addTo(this.map); if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(pos => { this.map.setView([pos.coords.latitude, pos.coords.longitude], 12); }); } },
            open(inputId) { this.targetInputId = inputId; document.getElementById('map-modal').classList.remove('hidden'); setTimeout(() => { this.init(); this.map.invalidateSize(); }, 100); if(this.stops.length === 0) this.reset(); else this.cleanMapLayers(); },
            reset() { this.stops = []; document.getElementById('stops-list').innerHTML = ''; this.addStopInput('èµ·é» (è¼¸å…¥åœ°å€)'); this.addStopInput('çµ‚é» (è¼¸å…¥åœ°å€)'); this.cleanMapLayers(); },
            cleanMapLayers() { if(this.polyline) this.map.removeLayer(this.polyline); this.stops.forEach(s => { if(s.marker) this.map.removeLayer(s.marker); s.coords = null; s.marker = null; }); this.calculatedKm = 0; document.getElementById('map-result-text').innerText = '0.0 km'; document.getElementById('btn-map-confirm').disabled = true; },
            addStopInput(placeholder = 'é€”ç¶“é»') { const id = Date.now() + Math.random(); const stop = { id, text: '', coords: null, marker: null }; this.stops.push(stop); this.renderStopList(); },
            removeStop(id) { if(this.stops.length <= 2) return alert('è‡³å°‘éœ€è¦èµ·é»å’Œçµ‚é»'); const idx = this.stops.findIndex(s => s.id === id); if(this.stops[idx].marker) this.map.removeLayer(this.stops[idx].marker); this.stops = this.stops.filter(s => s.id !== id); this.renderStopList(); this.cleanMapLayers(); },
            renderStopList() { const container = document.getElementById('stops-list'); container.innerHTML = ''; this.stops.forEach((stop, index) => { const isStart = index === 0; const isEnd = index === this.stops.length - 1; const label = isStart ? 'èµ·' : isEnd ? 'çµ‚' : (index); const colorClass = isStart ? 'bg-brand-dark dark:bg-emerald-600' : isEnd ? 'bg-brand-accent dark:bg-orange-500' : 'bg-gray-400'; const div = document.createElement('div'); div.className = 'flex items-center gap-2 animate-[fadeIn_0.2s]'; div.innerHTML = `<div class="flex-none w-6 h-6 rounded-full ${colorClass} text-white text-xs font-bold flex items-center justify-center">${label}</div><input type="text" class="flex-1 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 text-sm border border-transparent focus:bg-white focus:border-brand-dark outline-none transition" placeholder="${isStart?'è¼¸å…¥åœ°å€...':isEnd?'è¼¸å…¥åœ°å€...':'è¼¸å…¥é€”ç¶“é»...'}" value="${stop.text}">${this.stops.length > 2 ? `<button onclick="MapPicker.removeStop(${stop.id})" class="text-gray-300 hover:text-red-400 px-1"><i class="fa-solid fa-xmark"></i></button>` : ''}`; div.querySelector('input').addEventListener('input', (e) => stop.text = e.target.value); container.appendChild(div); }); },
            async processInputs() { const inputs = this.stops.filter(s => s.text.trim() !== ''); if (inputs.length < 2) return alert('è«‹è‡³å°‘è¼¸å…¥èµ·é»å’Œçµ‚é»'); document.getElementById('map-result-text').innerText = 'å®šä½ä¸­...'; this.stops.forEach(s => { if(s.marker) this.map.removeLayer(s.marker); }); for (let i = 0; i < inputs.length; i++) { const stop = inputs[i]; try { const coords = await this.smartGeocode(stop.text); if (coords) { stop.coords = coords; this.addMarker(stop, i); } else { alert(`æ‰¾ä¸åˆ°: ${stop.text} (å»ºè­°è¼¸å…¥å®Œæ•´åœ°å€)`); document.getElementById('map-result-text').innerText = 'å®šä½å¤±æ•—'; return; } await new Promise(r => setTimeout(r, 600)); } catch (e) { alert('ç¶²è·¯éŒ¯èª¤'); return; } } this.calculateRoute(); },
            async smartGeocode(query) { let res = await this.geocode(query); if (res) return res; const noZip = query.replace(/^\d{3,5}/, '').trim(); if (noZip !== query) { res = await this.geocode(noZip); if (res) return res; } const noDetail = noZip.replace(/[\d]+[ä¹‹\-]\d+è™Ÿ?|[\d]+[è™Ÿæ¨“Ff].*$/, '').trim(); if (noDetail !== noZip && noDetail.length > 3) { res = await this.geocode(noDetail); if (res) return res; } return null; },
            async geocode(query) { try { const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`; const res = await fetch(url); const data = await res.json(); if (data && data.length > 0) return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) }; } catch(e) { return null; } return null; },
            addMarker(stop, index) { const label = (index + 1).toString(); const html = `<div class="pin-number">${label}</div>`; const icon = L.divIcon({ className: 'custom-pin', html: html, iconSize: [24, 24] }); const marker = L.marker([stop.coords.lat, stop.coords.lng], { icon: icon, draggable: true }).addTo(this.map); marker.on('dragend', (e) => { stop.coords = e.target.getLatLng(); this.calculateRoute(); }); stop.marker = marker; },
            async calculateRoute() { const activeStops = this.stops.filter(s => s.coords); if (activeStops.length < 2) return; document.getElementById('map-result-text').innerText = 'ä¼°ç®—ä¸­...'; const coordString = activeStops.map(s => `${s.coords.lng},${s.coords.lat}`).join(';');
                const url = `https://router.project-osrm.org/route/v1/foot/${coordString}?overview=full&geometries=geojson`; 
                try { const res = await fetch(url); const data = await res.json(); if (data.code === 'Ok' && data.routes.length > 0) { const route = data.routes[0]; this.calculatedKm = (route.distance / 1000).toFixed(2); document.getElementById('map-result-text').innerText = `${this.calculatedKm} km`; document.getElementById('btn-map-confirm').disabled = false; if (this.polyline) this.map.removeLayer(this.polyline); const latlngs = route.geometry.coordinates.map(c => [c[1], c[0]]); this.polyline = L.polyline(latlngs, { color: '#ef4444', weight: 4, opacity: 0.7, dashArray: '10, 10' }).addTo(this.map); this.map.fitBounds(this.polyline.getBounds(), { padding: [50, 50] }); } } catch (e) { document.getElementById('map-result-text').innerText = 'è¨ˆç®—å¤±æ•—'; } },
            confirm() { if (this.targetInputId) document.getElementById(this.targetInputId).value = this.calculatedKm; const active = this.stops.filter(s => s.coords); if(active.length >= 2) { window.tempMapCoords = { start: active[0].coords, end: active[active.length-1].coords, waypoints: active.slice(1, -1).map(s => s.coords) }; const startInput = document.getElementById(this.targetInputId.replace('km', 'start')); const endInput = document.getElementById(this.targetInputId.replace('km', 'end')); if(startInput && !startInput.value) startInput.value = active[0].text; if(endInput && !endInput.value) endInput.value = active[active.length-1].text; } App.closeMapModal(); }
        };

        const App = {
            data: { logs: [], routes: [], stays: [], gears: [], targetKm: 1200 }, 
            currentView: 'log', firstDate: null, 
            logMode: 'list', calendarDate: new Date(),

            init() { try { this.loadData(); this.initTheme(); this.router('log'); if(this.data.gears.length === 0) this.seedGearData(); window.App = this; window.MapPicker = MapPicker; } catch(e) { throw new Error("Init Failed: " + e.message); } },
            
            // Theme Logic
            initTheme() {
                // Check stored or system pref
                if (localStorage.getItem('island_walker_theme') === 'dark' || (!('island_walker_theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                    document.getElementById('theme-icon').classList.replace('fa-moon', 'fa-sun');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.getElementById('theme-icon').classList.replace('fa-sun', 'fa-moon');
                }
            },
            toggleTheme() {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('island_walker_theme', isDark ? 'dark' : 'light');
                const icon = document.getElementById('theme-icon');
                if(isDark) icon.classList.replace('fa-moon', 'fa-sun');
                else icon.classList.replace('fa-sun', 'fa-moon');
            },

            loadData() { 
                const stored = localStorage.getItem('island_walker_v17_db'); 
                if (stored) { 
                    this.data = JSON.parse(stored); 
                } else if (localStorage.getItem('island_walker_v16_db')) { 
                    const v = JSON.parse(localStorage.getItem('island_walker_v16_db'));
                    this.data = { ...v, targetKm: 1200 };
                    this.saveData(); 
                }
            },
            saveData() { localStorage.setItem('island_walker_v17_db', JSON.stringify(this.data)); this.calculateFirstDate(); this.updateGlobalStats(); },
            calculateFirstDate() { if (this.data.logs.length > 0) { const sorted = [...this.data.logs].sort((a,b) => new Date(a.date) - new Date(b.date)); this.firstDate = sorted[0].date; } else { this.firstDate = null; } },
            getDayNumber(dateStr) { if (!this.firstDate) return 1; const start = Utils.getMidnight(this.firstDate); const current = Utils.getMidnight(dateStr); const diffTime = current - start; return Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1; },
            updateGlobalStats() { const totalKm = this.data.logs.reduce((acc, curr) => acc + Number(curr.km || 0), 0); const today = new Date().toISOString().split('T')[0]; const dayText = this.firstDate ? `Day ${this.getDayNumber(today)}` : 'æœªé–‹å§‹'; const el = document.getElementById('total-stats'); if(el) el.innerText = `${dayText} â€¢ ç´¯ç© ${totalKm.toFixed(1)} km`; },
            
            router(view) {
                this.currentView = view; document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const navEl = document.getElementById(`nav-${view}`); if(navEl) navEl.classList.add('active');
                const container = document.getElementById('app-container'); window.scrollTo(0, 0);
                switch(view) {
                    case 'log': this.renderLogView(container); break;
                    case 'route': this.renderRouteView(container); break;
                    case 'stay': this.renderStayView(container); break;
                    case 'gear': this.renderGearView(container); break;
                    case 'stats': this.renderStatsView(container); break;
                }
                this.updateGlobalStats();
            },

            // --- Stats View with Backup & Share ---
            renderStatsView(container) {
                const totalKm = this.data.logs.reduce((acc, c) => acc + Number(c.km||0), 0);
                const progress = Math.min((totalKm / this.data.targetKm) * 100, 100).toFixed(1);
                let stayTotal = 0, foodTotal = 0;
                this.data.logs.forEach(l => { stayTotal += this.getStayCostByDate(l.date); if(l.expenses) { l.expenses.forEach(e => foodTotal += Number(e.price)); } else if(l.otherCost) foodTotal += Number(l.otherCost); });
                const totalCost = stayTotal + foodTotal;
                
                container.innerHTML = `
                    <div class="space-y-6 animate-[fadeIn_0.3s]">
                        <!-- Progress Card -->
                        <div class="card p-5 bg-gradient-to-br from-brand-dark to-[#1a4036] text-white relative overflow-hidden">
                            <i class="fa-solid fa-person-hiking absolute -right-4 -bottom-4 text-8xl text-white opacity-10"></i>
                            <div class="flex justify-between items-end mb-2">
                                <div><h3 class="text-sm opacity-80">ç’°å³¶é€²åº¦</h3><div class="text-3xl font-bold font-num">${totalKm.toFixed(1)} <span class="text-sm">km</span></div></div>
                                <div class="text-right"><div class="text-sm opacity-80">ç›®æ¨™ (ä¿®æ”¹)</div><div class="text-xl font-bold font-num cursor-pointer" onclick="App.editTarget()">${this.data.targetKm} <i class="fa-solid fa-pen text-xs opacity-50"></i></div></div>
                            </div>
                            <div class="w-full bg-white/20 rounded-full h-3 mb-1"><div class="bg-brand-accent h-3 rounded-full transition-all duration-1000" style="width: ${progress}%"></div></div>
                            <div class="text-right text-xs font-bold">${progress}% å®Œæˆ</div>
                            <button onclick="App.openShareModal('${totalKm.toFixed(1)}', '${this.getDayNumber(new Date().toISOString().split('T')[0])}', '${progress}')" class="mt-4 w-full bg-white/20 hover:bg-white/30 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2">
                                <i class="fa-solid fa-share-nodes"></i> ç”¢ç”Ÿåˆ†äº«å¡ç‰‡
                            </button>
                        </div>

                        <!-- Chart -->
                        <div class="card p-5">
                            <h3 class="font-bold text-brand-dark dark:text-emerald-400 mb-4 border-b dark:border-gray-700 pb-2">èŠ±è²»åˆ†æ ($${totalCost})</h3>
                            <div class="h-48 relative"><canvas id="expenseChart"></canvas></div>
                        </div>

                        <!-- System Settings -->
                        <div class="card p-5">
                            <h3 class="font-bold text-gray-500 mb-3 border-b dark:border-gray-700 pb-2">è³‡æ–™ç®¡ç†</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="App.exportData()" class="bg-blue-50 dark:bg-blue-900 text-blue-600 dark:text-blue-200 py-3 rounded-xl font-bold text-sm"><i class="fa-solid fa-download mb-1 block text-lg"></i> å‚™ä»½/åŒ¯å‡º</button>
                                <button onclick="document.getElementById('import-file').click()" class="bg-green-50 dark:bg-green-900 text-green-600 dark:text-green-200 py-3 rounded-xl font-bold text-sm"><i class="fa-solid fa-upload mb-1 block text-lg"></i> é‚„åŸ/åŒ¯å…¥</button>
                                <input type="file" id="import-file" class="hidden" accept=".json" onchange="App.importData(this)">
                            </div>
                            <p class="text-[10px] text-gray-400 mt-2 text-center">å¯å°‡å‚™ä»½æª”å‚³çµ¦æœ‹å‹ï¼Œæˆ–å­˜è‡³é›²ç«¯ã€‚</p>
                        </div>
                    </div>
                `;
                
                setTimeout(() => { 
                    const ctx = document.getElementById('expenseChart'); 
                    if(ctx) { 
                        new Chart(ctx, { type: 'doughnut', data: { labels: ['ä½å®¿', 'é£²é£Ÿ/é›œæ”¯'], datasets: [{ data: [stayTotal, foodTotal], backgroundColor: ['#2C5E50', '#E76F51'], borderWidth: 0 }] }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: document.documentElement.classList.contains('dark') ? '#fff' : '#666' } } } } }); 
                    } 
                }, 100);
            },
            
            // Feature 1: Export/Import
            exportData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                const date = new Date().toISOString().split('T')[0];
                downloadAnchorNode.setAttribute("download", "island_walker_backup_" + date + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            },
            importData(input) {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if(confirm('ç¢ºå®šè¦è¦†è“‹ç›®å‰çš„è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                            App.data = imported;
                            App.saveData();
                            alert('è³‡æ–™é‚„åŸæˆåŠŸï¼');
                            location.reload();
                        }
                    } catch(err) {
                        alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                    }
                };
                reader.readAsText(file);
            },

            // Feature 2: Share Modal
            openShareModal(km, day, pct) {
                document.getElementById('share-km').innerText = km;
                document.getElementById('share-day').innerText = day;
                document.getElementById('share-pct').innerText = pct + '%';
                document.getElementById('share-bar').style.width = pct + '%';
                document.getElementById('share-modal').classList.remove('hidden');
            },

            editTarget() { const newT = prompt('è¨­å®šç›®æ¨™å…¬é‡Œæ•¸', this.data.targetKm); if(newT && !isNaN(newT)) { this.data.targetKm = Number(newT); this.saveData(); this.router('stats'); } },

            // --- Log View ---
            renderLogView(container) {
                const modeHtml = `<div class="flex justify-center mb-4 sticky top-0 z-20 bg-brand-bg dark:bg-gray-900 py-2 transition-colors"><div class="bg-gray-200 dark:bg-gray-700 p-1 rounded-xl flex text-xs font-bold shadow-inner"><button onclick="App.setLogMode('list')" class="px-6 py-2 rounded-lg transition-all ${this.logMode==='list'?'bg-white dark:bg-gray-600 text-brand-dark dark:text-white shadow':'text-gray-500 dark:text-gray-400'}">åˆ—è¡¨</button><button onclick="App.setLogMode('calendar')" class="px-6 py-2 rounded-lg transition-all ${this.logMode==='calendar'?'bg-white dark:bg-gray-600 text-brand-dark dark:text-white shadow':'text-gray-500 dark:text-gray-400'}">æœˆæ›†</button></div></div>`;

                if(this.logMode === 'list') {
                    let listHtml = '';
                    if (this.data.logs.length === 0) listHtml += `<div class="flex flex-col items-center justify-center h-[50vh] text-gray-300"><i class="fa-solid fa-book-open text-6xl mb-4"></i><p>é–‹å§‹ç´€éŒ„ä½ çš„ç¬¬ä¸€å¤©</p></div>`; 
                    else {
                        const sortedLogs = [...this.data.logs].sort((a,b) => new Date(b.date) - new Date(a.date));
                        sortedLogs.forEach(log => {
                            const dayNum = this.getDayNumber(log.date);
                            const stayCost = this.getStayCostByDate(log.date);
                            const expenses = log.expenses || [];
                            const totalCost = expenses.reduce((acc, curr) => acc + Number(curr.price), 0) + stayCost;
                            let healthHtml = '';
                            if(log.health) {
                                const duration = log.health.duration || log.health.sleep || '0';
                                healthHtml = `<div class="flex gap-2 mt-2 pt-2 border-t border-gray-100 dark:border-gray-700 text-xs text-gray-500 dark:text-gray-400"><span><i class="fa-solid fa-stopwatch"></i> ${duration}h</span><span>${log.health.condition==='good'?'ğŸ’ª ç‹€æ…‹ä½³':log.health.condition==='bad'?'âš ï¸ ä¸é©':'ğŸ†— æ™®é€š'}</span>${log.health.pain?`<span>ğŸ’Š ${log.health.pain}</span>`:''}</div>`;
                            }
                            const displayStart = Utils.extractCityDistrict(log.start) || log.start;
                            const displayEnd = Utils.extractCityDistrict(log.end) || log.end;
                            const headerHtml = Utils.renderCardHeader(dayNum, log.date, `<button onclick="App.openLogModal(${log.id})" class="text-gray-300 p-2"><i class="fa-solid fa-pen-to-square"></i></button>`);

                            listHtml += `<div class="card p-5 mb-5 border-l-[6px] border-brand-dark dark:border-emerald-600">${headerHtml}<h3 class="text-xl font-bold text-brand-dark dark:text-emerald-400 mb-1 flex items-center">${displayStart} <i class="fa-solid fa-arrow-right-long text-sm mx-2 text-gray-300"></i> ${displayEnd}</h3><div class="grid grid-cols-2 gap-3 my-3"><div class="bg-gray-50 dark:bg-gray-700 p-2 rounded-lg"><div class="text-xs text-gray-400">é‡Œç¨‹</div><div class="font-bold text-brand-dark dark:text-white font-num text-lg">${log.km} <span class="text-xs">km</span></div></div><div class="bg-gray-50 dark:bg-gray-700 p-2 rounded-lg"><div class="text-xs text-gray-400">ç¸½èŠ±è²»</div><div class="font-bold text-brand-accent dark:text-orange-400 font-num text-lg">$${totalCost}</div></div></div>${healthHtml}<div class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed whitespace-pre-line mt-3">${log.note || ''}</div></div>`;
                        });
                    }
                    container.innerHTML = modeHtml + listHtml;
                    this.addFab(container, 'fa-plus', () => this.openLogModal());
                } else {
                    container.innerHTML = modeHtml + `<div id="calendar-container" class="animate-[fadeIn_0.2s]"></div>`;
                    this.renderCalendar();
                }
            },
            setLogMode(mode) { this.logMode = mode; this.router('log'); },

            renderCalendar() {
                const container = document.getElementById('calendar-container'); if(!container) return;
                const year = this.calendarDate.getFullYear(); const month = this.calendarDate.getMonth();
                const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate(); const startDayOfWeek = firstDay.getDay();
                let html = `<div class="card p-4 mb-4"><div class="flex justify-between items-center mb-4"><button onclick="App.changeMonth(-1)" class="p-2 text-gray-400"><i class="fa-solid fa-chevron-left"></i></button><h3 class="font-bold text-lg text-brand-dark dark:text-emerald-400 font-num">${year}å¹´ ${month+1}æœˆ</h3><button onclick="App.changeMonth(1)" class="p-2 text-gray-400"><i class="fa-solid fa-chevron-right"></i></button></div><div class="grid grid-cols-7 gap-1 text-center mb-2 text-xs text-gray-400 font-bold"><div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div><div class="grid grid-cols-7 gap-2">`;
                for (let i = 0; i < startDayOfWeek; i++) { html += `<div></div>`; }
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const log = this.data.logs.find(l => l.date === dateStr);
                    let contentHtml = `<div class="text-xs font-num mb-1 text-gray-600 dark:text-gray-400">${d}</div>`;
                    if(log) {
                        let healthIcon = '';
                        if(log.health) healthIcon = log.health.condition==='good'?'ğŸ’ª':log.health.condition==='bad'?'âš ï¸':'ğŸ†—';
                        contentHtml += `<div class="text-[14px] mb-1 text-center">${healthIcon}</div>`;
                        if(log.km) contentHtml += `<div class="text-[9px] text-brand-dark dark:text-emerald-300 font-num font-bold leading-tight">${log.km}<span class="text-[7px] text-gray-400 font-normal">km</span></div>`;
                        const duration = (log.health && (log.health.duration || log.health.sleep)) || '0';
                        if(duration != '0') contentHtml += `<div class="text-[9px] text-gray-400 font-num leading-tight">â±ï¸${duration}h</div>`;
                    } else { contentHtml += `<div class="flex-1"></div>`; }
                    const todayClass = dateStr === new Date().toISOString().split('T')[0] ? 'cal-today' : '';
                    const hasDataClass = log ? 'bg-brand-light dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-700';
                    html += `<div onclick="App.openLogFromCal('${dateStr}', ${log ? log.id : null})" class="cal-cell ${hasDataClass} ${todayClass}">${contentHtml}</div>`;
                }
                html += `</div>
                <div class="flex gap-4 text-xs text-gray-500 dark:text-gray-400 mt-4 justify-center border-t dark:border-gray-700 pt-3 pb-10">
                    <span>ğŸ’ª ç‹€æ…‹ä½³</span> <span>ğŸ†— æ™®é€š</span> <span>âš ï¸ ä¸é©</span>
                </div>
                </div>`;
                container.innerHTML = html;
            },
            changeMonth(delta) { this.calendarDate.setMonth(this.calendarDate.getMonth() + delta); this.renderCalendar(); },
            openLogFromCal(dateStr, logId) { if (logId) { this.openLogModal(logId); } else { this.openLogModal(null, dateStr); } },

            openLogModal(editId = null, prefillDate = null) {
                const isEdit = editId !== null;
                let data = { expenses: [] };
                if(isEdit) data = this.data.logs.find(l => l.id === editId);
                if(data.otherCost && (!data.expenses || data.expenses.length === 0)) data.expenses = [{name: 'é›œæ”¯', price: data.otherCost}];
                const stayCost = isEdit ? this.getStayCostByDate(data.date) : 0;
                const dateValue = data.date || prefillDate || new Date().toISOString().split('T')[0];
                const h = data.health || { duration: '', condition: 'avg', pain: '' };
                if(h.sleep && !h.duration) h.duration = h.sleep;

                const formHtml = `
                    <div class="space-y-4">
                        <input type="date" id="log-date" class="input-field font-num w-full" value="${dateValue}" onchange="App.checkRouteForDate(this.value)">
                        
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-xl border border-blue-100 dark:border-blue-800">
                            <label class="text-xs font-bold text-blue-800 dark:text-blue-300 mb-2 block">ğŸš¶ è¡Œèµ°ç´€éŒ„</label>
                            <div class="grid grid-cols-2 gap-3 mb-3"><input type="text" id="log-start" class="input-field" placeholder="èµ·é»" value="${data.start || ''}"><input type="text" id="log-end" class="input-field" placeholder="çµ‚é»" value="${data.end || ''}"></div>
                            <div class="relative"><input type="number" id="log-km" class="input-field pr-4 font-num" placeholder="ä»Šæ—¥é‡Œç¨‹ (km)" inputmode="decimal" value="${data.km || ''}"></div>
                        </div>

                        <div class="bg-red-50 dark:bg-red-900/30 p-3 rounded-xl border border-red-100 dark:border-red-800">
                            <label class="text-xs font-bold text-red-800 dark:text-red-300 mb-2 block">ğŸ¥ èº«é«”ç‹€æ…‹</label>
                            <div class="flex gap-2 mb-3">
                                <label class="flex-1 cursor-pointer"><input type="radio" name="h-cond" value="good" class="peer hidden" ${h.condition==='good'?'checked':''}><div class="text-center py-2 border rounded-xl bg-white dark:bg-gray-800 dark:border-gray-600 peer-checked:bg-brand-dark peer-checked:text-white transition text-xs">ğŸ’ª ç‹€æ…‹ä½³</div></label>
                                <label class="flex-1 cursor-pointer"><input type="radio" name="h-cond" value="avg" class="peer hidden" ${h.condition==='avg'||!h.condition?'checked':''}><div class="text-center py-2 border rounded-xl bg-white dark:bg-gray-800 dark:border-gray-600 peer-checked:bg-brand-earth peer-checked:text-white transition text-xs">ğŸ†— æ™®é€š</div></label>
                                <label class="flex-1 cursor-pointer"><input type="radio" name="h-cond" value="bad" class="peer hidden" ${h.condition==='bad'?'checked':''}><div class="text-center py-2 border rounded-xl bg-white dark:bg-gray-800 dark:border-gray-600 peer-checked:bg-red-500 peer-checked:text-white transition text-xs">âš ï¸ ä¸é©</div></label>
                            </div>
                            <div class="flex gap-2"><input type="number" id="h-duration" class="input-field flex-1" placeholder="è¡Œèµ° (hr)" value="${h.duration || ''}"><input type="text" id="h-pain" class="input-field flex-[2]" placeholder="ç–¼ç—›éƒ¨ä½" value="${h.pain || ''}"></div>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-xl border border-gray-100 dark:border-gray-600"><div class="flex justify-between items-center mb-2"><label class="text-xs font-bold text-gray-500 dark:text-gray-300">ğŸ’° ç•¶æ—¥é–‹éŠ·</label><button onclick="App.addExpenseRow()" class="text-xs bg-brand-dark dark:bg-emerald-600 text-white px-2 py-1 rounded">æ–°å¢</button></div><div id="expense-container" class="space-y-2"></div>${stayCost > 0 ? `<div class="text-xs text-blue-600 dark:text-blue-300 mt-2 text-right">ä½å®¿è²» $${stayCost} (è‡ªå‹•å¸¶å…¥)</div>` : ''}</div>
                        
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400 block">ä»Šæ—¥å¿ƒå¾—</label>
                        <textarea id="log-note" class="input-field h-24" placeholder="æ—¥è¨˜å¿ƒå¾—...">${data.note || ''}</textarea>
                        
                        <button onclick="App.submitLog(${editId})" class="w-full bg-brand-dark dark:bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg mt-2">${isEdit ? 'æ›´æ–°' : 'å„²å­˜'}</button>
                        ${isEdit ? `<button onclick="App.deleteLog(${editId})" class="w-full text-red-400 text-sm mt-3">åˆªé™¤</button>` : ''}
                    </div>
                `;
                this.showModal(isEdit ? 'ç·¨è¼¯æ—¥è¨˜' : 'æ–°å¢æ—¥è¨˜', formHtml);
                const exContainer = document.getElementById('expense-container');
                if(data.expenses && data.expenses.length > 0) data.expenses.forEach(e => this.addExpenseRow(e.name, e.price));
                else this.addExpenseRow();
                
                // Feature 4: Auto check route if new log
                if (!isEdit) this.checkRouteForDate(dateValue);
            },

            checkRouteForDate(dateStr) {
                const route = this.data.routes.find(r => r.date === dateStr);
                const startEl = document.getElementById('log-start');
                const endEl = document.getElementById('log-end');
                const kmEl = document.getElementById('log-km');
                
                if (route) {
                    startEl.value = route.start;
                    endEl.value = route.end;
                    kmEl.value = route.estKm;
                    [startEl, endEl, kmEl].forEach(el => { el.style.backgroundColor = '#E8F5E9'; setTimeout(() => el.style.backgroundColor = '', 500); });
                } else {
                    // Feature 4: Clear if no route found
                    startEl.value = '';
                    endEl.value = '';
                    kmEl.value = '';
                }
            },

            submitLog(editId) {
                const expenses = [];
                document.querySelectorAll('.expense-row').forEach(row => { const name = row.querySelector('.ex-name').value; const price = row.querySelector('.ex-price').value; if(name && price) expenses.push({name, price}); });
                const health = { condition: document.querySelector('input[name="h-cond"]:checked').value, duration: document.getElementById('h-duration').value, pain: document.getElementById('h-pain').value };
                const newLog = { id: editId || Date.now(), date: document.getElementById('log-date').value, start: document.getElementById('log-start').value, end: document.getElementById('log-end').value, km: document.getElementById('log-km').value, expenses: expenses, health: health, mood: 'normal', note: document.getElementById('log-note').value, coords: window.tempMapCoords || (editId ? this.data.logs.find(l=>l.id===editId).coords : null) };
                if (editId) { const idx = this.data.logs.findIndex(l => l.id === editId); this.data.logs[idx] = newLog; } else { this.data.logs.unshift(newLog); }
                window.tempMapCoords = null; this.saveData(); this.closeModal(); this.router('log');
            },

            renderRouteView(container) {
                let html = `<a href="https://www.google.com/maps" target="_blank" class="flex items-center justify-center bg-white dark:bg-gray-800 text-brand-dark dark:text-white py-3 rounded-xl mb-6 shadow-sm border border-gray-100 dark:border-gray-700 font-bold"><i class="fa-brands fa-google text-lg mr-2 text-red-500"></i> é–‹å•Ÿ Google Maps</a>`;
                if (this.data.routes.length === 0) html += `<div class="text-center text-gray-400 mt-10">å°šæœªè¦åŠƒè·¯ç·š</div>`;
                else {
                    html += '<div class="relative border-l-2 border-brand-earth/30 ml-4 pl-6 py-2 space-y-6">';
                    this.data.routes.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(route => {
                        const isToday = route.date === new Date().toISOString().split('T')[0];
                        let navLink = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(route.start)}&destination=${encodeURIComponent(route.end)}&travelmode=walking`;
                        if (route.coords && route.coords.waypoints && route.coords.waypoints.length > 0) { const waypoints = route.coords.waypoints.map(w => `${w.lat},${w.lng}`).join('|'); navLink = `https://www.google.com/maps/dir/?api=1&origin=${route.coords.start.lat},${route.coords.start.lng}&destination=${route.coords.end.lat},${route.coords.end.lng}&waypoints=${waypoints}&travelmode=walking`; } else if (route.coords && route.coords.start) { navLink = `https://www.google.com/maps/dir/?api=1&origin=${route.coords.start.lat},${route.coords.start.lng}&destination=${route.coords.end.lat},${route.coords.end.lng}&travelmode=walking`; }
                        const displayStart = Utils.extractCityDistrict(route.start) || route.start;
                        const displayEnd = Utils.extractCityDistrict(route.end) || route.end;
                        const headerHtml = Utils.renderCardHeader(route.dayNum, route.date, `<button onclick="App.openRouteModal(${route.id})" class="text-gray-300 px-2"><i class="fa-solid fa-pen"></i></button>`);
                        html += `<div class="relative group"><div class="absolute -left-[33px] top-4 w-4 h-4 rounded-full bg-brand-dark dark:bg-emerald-600 ${isToday ? 'ring-4 ring-brand-accent/30 bg-brand-accent' : ''}"></div><div class="card p-4 ${isToday ? 'border-2 border-brand-accent' : ''}">${headerHtml}<h4 class="font-bold text-lg text-brand-dark dark:text-white mb-1">${displayStart} â†’ ${displayEnd}</h4><div class="text-sm text-gray-600 dark:text-gray-300 mb-3 font-num font-medium">é ä¼°ï¼š${route.estKm} km</div><div class="flex gap-2 mt-3"><a href="${navLink}" target="_blank" class="flex-1 bg-brand-dark dark:bg-emerald-600 text-white py-2 rounded-lg text-xs font-bold text-center flex items-center justify-center"><i class="fa-solid fa-location-arrow mr-1"></i> å°èˆª</a>${route.note ? `<div class="text-xs text-gray-500 bg-brand-light dark:bg-gray-700 p-2 rounded mt-2 flex-1">${route.note}</div>` : ''}</div></div></div>`;
                    });
                    html += '</div>';
                }
                container.innerHTML = html;
                this.addFab(container, 'fa-map-pin', () => this.openRouteModal());
            },
            openRouteModal(editId = null) {
                const isEdit = editId !== null; let data = {}; if(isEdit) data = this.data.routes.find(r => r.id === editId);
                const formHtml = `<div class="space-y-4"><div class="flex gap-2"><input type="number" id="route-day" class="input-field w-1/3 font-num" placeholder="Day" value="${data.dayNum || ''}"><input type="date" id="route-date" class="input-field w-2/3 font-num" value="${data.date || ''}" onchange="App.autoCalcRouteDay(this.value)"></div><div class="grid grid-cols-2 gap-3"><input type="text" id="route-start" class="input-field" placeholder="èµ·é»" value="${data.start || ''}"><input type="text" id="route-end" class="input-field" placeholder="çµ‚é»" value="${data.end || ''}"></div><div class="relative"><input type="number" id="route-km" class="input-field pr-24 font-num" placeholder="é ä¼° km" value="${data.estKm || ''}"><button onclick="MapPicker.open('route-km')" class="absolute right-2 top-2 text-white bg-brand-dark text-xs px-3 py-2 rounded-lg font-bold shadow-sm flex items-center gap-1"><i class="fa-solid fa-map"></i> æ¸¬è·</button></div><input type="text" id="route-note" class="input-field" placeholder="å‚™è¨»" value="${data.note || ''}"><button onclick="App.submitRoute(${editId})" class="w-full bg-brand-dark dark:bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg mt-2">${isEdit ? 'æ›´æ–°' : 'æ–°å¢'}</button>${isEdit ? `<button onclick="App.deleteRoute(${editId})" class="w-full text-red-400 text-sm mt-3">åˆªé™¤</button>` : ''}</div>`;
                this.showModal(isEdit ? 'ç·¨è¼¯è¦åŠƒ' : 'æ–°å¢è¦åŠƒ', formHtml);
                if (!isEdit && !data.dayNum) { const today = new Date().toISOString().split('T')[0]; App.autoCalcRouteDay(today); }
            },
            autoCalcRouteDay(dateStr) { const diff = this.getDayNumber(dateStr); document.getElementById('route-day').value = diff; },
            submitRoute(editId) { const newRoute={id:editId||Date.now(),dayNum:document.getElementById('route-day').value,date:document.getElementById('route-date').value,start:document.getElementById('route-start').value,end:document.getElementById('route-end').value,estKm:document.getElementById('route-km').value,note:document.getElementById('route-note').value,coords:window.tempMapCoords||(editId?this.data.routes.find(r=>r.id===editId).coords:null)}; if(editId){const idx=this.data.routes.findIndex(r=>r.id===editId);this.data.routes[idx]=newRoute;}else{this.data.routes.push(newRoute);}window.tempMapCoords=null;this.saveData();this.closeModal();this.router('route'); },
            deleteRoute(id) { if(confirm('åˆªé™¤?')) { this.data.routes = this.data.routes.filter(r => r.id !== id); this.saveData(); this.closeModal(); this.router('route'); }},
            renderStayView(container) { let html = ''; if (this.data.stays.length === 0) html += `<div class="text-center text-gray-400 mt-20">å°šæœªç´€éŒ„ä½å®¿</div>`; else { this.data.stays.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(stay => { const dayNum = this.getDayNumber(stay.date); const headerHtml = Utils.renderCardHeader(dayNum, stay.date, `<button onclick="App.openStayModal(${stay.id})" class="text-gray-300 px-2"><i class="fa-solid fa-pen"></i></button>`); html += `<div class="card p-5 mb-4">${headerHtml}<div class="flex justify-between items-center mt-2"><h3 class="text-xl font-bold text-brand-dark dark:text-emerald-400">${stay.name}</h3><span class="text-xs px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">${stay.type}</span></div><div class="text-brand-accent dark:text-orange-400 font-bold my-2 font-num text-lg">$${stay.price}</div>${stay.contact ? `<div class="text-sm text-gray-600 dark:text-gray-400 mb-1"><i class="fa-solid fa-phone w-5"></i> <a href="tel:${stay.contact}" class="underline">${stay.contact}</a></div>` : ''}${stay.note ? `<div class="text-xs text-gray-500 bg-brand-light dark:bg-gray-700 p-2 rounded mt-2">${stay.note}</div>` : ''}${stay.mapLink ? `<a href="${stay.mapLink}" target="_blank" class="mt-2 block text-center bg-blue-50 dark:bg-blue-900/30 py-2 rounded-lg text-sm font-bold text-blue-600 dark:text-blue-300 hover:bg-blue-100"><i class="fa-solid fa-map-location-dot"></i> é–‹å•Ÿåœ°åœ–</a>` : ''}</div>`; }); } container.innerHTML = html; this.addFab(container, 'fa-bed', () => this.openStayModal()); },
            openStayModal(editId = null) { const isEdit = editId !== null; let data = {}; if(isEdit) data = this.data.stays.find(s => s.id === editId); const formHtml = `<div class="space-y-4"><input type="date" id="stay-date" class="input-field font-num" value="${data.date || ''}"><input type="text" id="stay-name" class="input-field" placeholder="ä½å®¿åç¨±" value="${data.name || ''}"><div class="grid grid-cols-2 gap-3"><select id="stay-type" class="input-field">${['æ°‘å®¿','é’æ—…','æ—…é¤¨','å€Ÿå®¿','é‡å®¿'].map(t => `<option value="${t}" ${data.type===t?'selected':''}>${t}</option>`).join('')}</select><input type="number" id="stay-price" class="input-field font-num" placeholder="åƒ¹æ ¼" inputmode="numeric" value="${data.price || ''}"></div><input type="tel" id="stay-contact" class="input-field font-num" placeholder="é›»è©±" value="${data.contact || ''}"><div class="text-[10px] text-gray-500 bg-gray-50 p-2 rounded">å‚™è¨»ï¼šè«‹æ‰‹å‹•è²¼ä¸Š Google Maps åˆ†äº«é€£çµ (ç„¡æ³•è‡ªå‹•å¸¶å…¥è³‡æ–™)ã€‚</div><input type="text" id="stay-map" class="input-field" placeholder="Google Map åˆ†äº«é€£çµ" value="${data.mapLink || ''}"><input type="text" id="stay-note" class="input-field" placeholder="å‚™è¨» (æ’åº§ã€æ´—è¡£æ©Ÿ...)" value="${data.note || ''}"><button onclick="App.submitStay(${editId})" class="w-full bg-brand-dark dark:bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg mt-2">${isEdit ? 'æ›´æ–°' : 'å„²å­˜'}</button>${isEdit ? `<button onclick="App.deleteStay(${editId})" class="w-full text-red-400 text-sm mt-3">åˆªé™¤</button>` : ''}</div>`; this.showModal(isEdit?'ç·¨è¼¯ä½å®¿':'æ–°å¢ä½å®¿', formHtml); },
            submitStay(editId) { const newStay = { id: editId || Date.now(), date: document.getElementById('stay-date').value, name: document.getElementById('stay-name').value, type: document.getElementById('stay-type').value, price: document.getElementById('stay-price').value, contact: document.getElementById('stay-contact').value, mapLink: document.getElementById('stay-map').value, note: document.getElementById('stay-note').value }; if(editId) { const idx = this.data.stays.findIndex(s => s.id === editId); this.data.stays[idx] = newStay; } else { this.data.stays.push(newStay); } this.saveData(); this.closeModal(); this.router('stay'); },
            deleteStay(id) { if(confirm('åˆªé™¤?')) { this.data.stays = this.data.stays.filter(s => s.id !== id); this.saveData(); this.closeModal(); this.router('stay'); }},
            renderGearView(container) { container.innerHTML = `<div class="grid grid-cols-5 gap-2 mb-4 sticky top-0 bg-brand-bg dark:bg-gray-900 z-10 py-2 px-1"><button onclick="App.filterGear('all')" class="py-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm text-[10px] font-bold border border-gray-100 dark:border-gray-700 dark:text-gray-300">å…¨éƒ¨</button><button onclick="App.filterGear('clothing')" class="py-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm text-[10px] font-bold border border-gray-100 dark:border-gray-700 dark:text-gray-300">è¡£ç‰©</button><button onclick="App.filterGear('rain')" class="py-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm text-[10px] font-bold border border-gray-100 dark:border-gray-700 dark:text-gray-300">é›¨å…·</button><button onclick="App.filterGear('sleep')" class="py-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm text-[10px] font-bold border border-gray-100 dark:border-gray-700 dark:text-gray-300">ç¡çœ </button><button onclick="App.filterGear('elec')" class="py-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm text-[10px] font-bold border border-gray-100 dark:border-gray-700 dark:text-gray-300">é›»å­</button><button onclick="App.filterGear('clean')" class="py-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm text-[10px] font-bold border border-gray-100 dark:border-gray-700 dark:text-gray-300">æ¸…æ½”</button><button onclick="App.filterGear('med')" class="py-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm text-[10px] font-bold border border-gray-100 dark:border-gray-700 dark:text-gray-300">é†«è—¥</button><button onclick="App.filterGear('id')" class="py-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm text-[10px] font-bold border border-gray-100 dark:border-gray-700 dark:text-gray-300">éš¨èº«</button><button onclick="App.filterGear('food')" class="py-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm text-[10px] font-bold border border-gray-100 dark:border-gray-700 dark:text-gray-300">é£Ÿæ°´</button><button onclick="App.filterGear('other')" class="py-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm text-[10px] font-bold border border-gray-100 dark:border-gray-700 dark:text-gray-300">å…¶ä»–</button></div><div class="flex justify-between items-center mb-2 px-1"><h3 class="font-bold text-brand-dark dark:text-emerald-400">è£å‚™æ¸…å–®</h3><button onclick="App.openGearAdd()" class="text-sm text-brand-accent dark:text-orange-400 font-bold"><i class="fa-solid fa-plus"></i> æ–°å¢</button></div><div id="gear-list" class="space-y-2 pb-20"></div>`; this.filterGear('all'); },
            filterGear(c) { const el = document.getElementById('gear-list'); el.innerHTML = ''; const f = c === 'all' ? this.data.gears : this.data.gears.filter(g => g.cat === c); if(f.length === 0) { el.innerHTML = '<div class="text-center text-gray-300 py-10">ç„¡é …ç›®</div>'; return; } f.forEach(i => { const isChecked = i.checked; el.innerHTML += `<div class="card p-3 flex justify-between items-center"><div class="flex items-center flex-1 cursor-pointer" onclick="App.toggleGear(${i.id})"><i class="fa-regular ${isChecked ? 'fa-square-check text-brand-dark dark:text-emerald-400' : 'fa-square text-gray-300'} text-xl mr-3"></i><span class="${isChecked ? 'text-gray-400 line-through' : 'text-brand-dark dark:text-gray-200 font-medium'}">${i.name}</span></div><div class="flex gap-2"><button onclick="App.openGearEdit(${i.id})" class="text-gray-300 px-2 hover:text-blue-500"><i class="fa-solid fa-pen"></i></button><button onclick="App.deleteGear(${i.id})" class="text-gray-300 px-2 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></div></div>`; }); },
            toggleGear(id) { const g = this.data.gears.find(i=>i.id===id); if(g) { g.checked = !g.checked; this.saveData(); this.filterGear('all'); } },
            openGearAdd() { this.openGearModal(null); },
            openGearEdit(id) { this.openGearModal(id); },
            openGearModal(id) { const isEdit = id !== null; let data = { name: '', cat: 'clothing' }; if (isEdit) data = this.data.gears.find(g => g.id === id); const formHtml = `<div class="space-y-4"><input type="text" id="gear-name" class="input-field" placeholder="è£å‚™åç¨±" value="${data.name}"><select id="gear-cat" class="input-field"><option value="clothing" ${data.cat==='clothing'?'selected':''}>è¡£ç‰©</option><option value="rain" ${data.cat==='rain'?'selected':''}>é›¨å…·</option><option value="sleep" ${data.cat==='sleep'?'selected':''}>å¸³ç¯·/ç¡çœ </option><option value="elec" ${data.cat==='elec'?'selected':''}>é›»å­</option><option value="clean" ${data.cat==='clean'?'selected':''}>æ¸…æ½”</option><option value="med" ${data.cat==='med'?'selected':''}>é†«è—¥</option><option value="id" ${data.cat==='id'?'selected':''}>éš¨èº«</option><option value="food" ${data.cat==='food'?'selected':''}>é£Ÿæ°´</option><option value="other" ${data.cat==='other'?'selected':''}>å…¶ä»–</option></select><button onclick="App.submitGear(${id})" class="w-full bg-brand-dark dark:bg-emerald-600 text-white py-3 rounded-xl font-bold">${isEdit?'æ›´æ–°':'æ–°å¢'}</button></div>`; this.showModal(isEdit ? 'ç·¨è¼¯è£å‚™' : 'æ–°å¢è£å‚™', formHtml); },
            submitGear(id) { const name = document.getElementById('gear-name').value; const cat = document.getElementById('gear-cat').value; if(id) { const g = this.data.gears.find(i => i.id === id); if(g) { g.name = name; g.cat = cat; } } else { this.data.gears.push({ id: Date.now(), name: name, cat: cat, checked: false }); } this.saveData(); this.closeModal(); this.router('gear'); },
            deleteGear(id) { if(confirm('åˆªé™¤?')) { this.data.gears = this.data.gears.filter(g=>g.id!==id); this.saveData(); this.router('gear'); }},
            seedGearData() { this.data.gears = [{id:1,cat:'clothing',name:'ç™»å±±é‹/å¥è¡Œé‹',checked:false}, {id:2,cat:'clothing',name:'é‹å‹•é‹ï¼ˆå‚™ç”¨ï¼‰',checked:true}, {id:3,cat:'clothing',name:'æ‹–é‹',checked:true}, {id:4,cat:'clothing',name:'æ’æ±—è¡£ x2',checked:false}, {id:5,cat:'clothing',name:'ç™¼ç†±è¡£ x2',checked:true}, {id:6,cat:'clothing',name:'é•·è¢–æ’æ±—è¡£ x2',checked:true}, {id:7,cat:'clothing',name:'é•·è¤²æ’æ±—è¤² x2',checked:true}, {id:8,cat:'clothing',name:'é•·é‹å‹•æŸè¤² x2',checked:true}, {id:9,cat:'clothing',name:'çŸ­è¤²(ç¡è¤²)',checked:true}, {id:10,cat:'clothing',name:'å…§è¡£è¤² x2',checked:false}, {id:11,cat:'clothing',name:'äº”æŒ‡è¥ª x3',checked:true}, {id:12,cat:'clothing',name:'åšé•·è¥ª x1',checked:true}, {id:13,cat:'clothing',name:'ç¾½çµ¨å¤–å¥—',checked:false}, {id:14,cat:'clothing',name:'é˜²é¢¨å¤–å¥—',checked:true}, {id:15,cat:'clothing',name:'æ¼å¤«å¸½/é ­å·¾',checked:true}, {id:16,cat:'clothing',name:'æ¯›ç·šå¸½',checked:false}, {id:17,cat:'clothing',name:'åœå·¾',checked:true}, {id:18,cat:'clothing',name:'è¢–å¥—',checked:false}, {id:19,cat:'clothing',name:'å¤ªé™½çœ¼é¡',checked:false}, {id:20,cat:'rain',name:'è¼•ä¾¿/å…©æˆªå¼é›¨è¡£',checked:true}, {id:21,cat:'rain',name:'æ‘ºç–Šé›¨å‚˜',checked:true}, {id:22,cat:'rain',name:'èƒŒåŒ…é˜²æ°´å¥—',checked:true}, {id:23,cat:'rain',name:'é˜²æ°´è¢‹',checked:false}, {id:24,cat:'rain',name:'é‹å¥—',checked:false}, {id:25,cat:'sleep',name:'å¸³ç¯·',checked:false}, {id:26,cat:'sleep',name:'ç¡è¢‹',checked:false}, {id:27,cat:'sleep',name:'ç¡å¢Š',checked:false}, {id:28,cat:'sleep',name:'æ•é ­',checked:false}, {id:30,cat:'elec',name:'æ‰‹æ©Ÿ',checked:true}, {id:31,cat:'elec',name:'å»¶é•·ç·š',checked:false}, {id:32,cat:'elec',name:'è¡Œå‹•é›»æº x2',checked:true}, {id:33,cat:'elec',name:'å……é›»å™¨/æ’åº§',checked:false}, {id:34,cat:'elec',name:'é ­ç‡ˆ/æ‰‹é›»ç­’',checked:true}, {id:35,cat:'elec',name:'æ‰‹éŒ¶(GPS)',checked:true}, {id:36,cat:'elec',name:'è€³æ©Ÿ',checked:true}, {id:37,cat:'elec',name:'ç›¸æ©Ÿ',checked:false}, {id:38,cat:'elec',name:'è­¦ç¤ºç‡ˆ',checked:true}, {id:40,cat:'clean',name:'ç‰™åˆ·ç‰™è†',checked:true}, {id:41,cat:'clean',name:'å¿«ä¹¾æ¯›å·¾',checked:true}, {id:42,cat:'clean',name:'è‚¥çš‚/æ²æµ´ä¹³',checked:true}, {id:43,cat:'clean',name:'æ´—é¢ä¹³',checked:false}, {id:44,cat:'clean',name:'è¡›ç”Ÿç´™',checked:true}, {id:45,cat:'clean',name:'æ¿•ç´™å·¾',checked:false}, {id:46,cat:'clean',name:'é˜²æ›¬ä¹³',checked:false}, {id:47,cat:'clean',name:'é«’è¡£è¢‹',checked:false}, {id:48,cat:'clean',name:'åˆ®é¬åˆ€',checked:true}, {id:49,cat:'clean',name:'æŒ‡ç”²å‰ª',checked:true}, {id:50,cat:'med',name:'å€‹äººè—¥å“',checked:false}, {id:51,cat:'med',name:'é…’ç²¾/ä¹¾æ´—æ‰‹',checked:false}, {id:52,cat:'med',name:'æ­¢ç—›è—¥',checked:true}, {id:53,cat:'med',name:'è…¸èƒƒè—¥',checked:false}, {id:54,cat:'med',name:'æ„Ÿå†’è—¥',checked:false}, {id:55,cat:'med',name:'å°è­·å£«è—¥è†',checked:false}, {id:56,cat:'med',name:'å‡¡å£«æ—',checked:true}, {id:57,cat:'med',name:'ç— ç—›è²¼å¸ƒ',checked:false}, {id:58,cat:'med',name:'OKç¹ƒ/æ°´æ³¡è²¼',checked:true}, {id:59,cat:'med',name:'å½ˆæ€§ç¹ƒå¸¶',checked:false}, {id:60,cat:'med',name:'è­·è†',checked:false}, {id:61,cat:'med',name:'é‡ç·š',checked:true}, {id:70,cat:'id',name:'èº«åˆ†è­‰',checked:true}, {id:71,cat:'id',name:'å¥ä¿å¡',checked:true}, {id:72,cat:'id',name:'ç¾é‡‘/ä¿¡ç”¨å¡',checked:true}, {id:73,cat:'id',name:'æ‚ éŠå¡',checked:false}, {id:74,cat:'id',name:'ä¿éšªå–®å½±æœ¬',checked:false}, {id:75,cat:'id',name:'ç·Šæ€¥è¯çµ¡è³‡è¨Š',checked:false}, {id:76,cat:'id',name:'ç­†è¨˜æœ¬/ç­†',checked:false}, {id:80,cat:'food',name:'ä¿æº«ç“¶/æ°´è¢‹',checked:true}, {id:81,cat:'food',name:'èƒ½é‡æ£’',checked:false}, {id:82,cat:'food',name:'é¹½ç³–',checked:false}, {id:83,cat:'food',name:'æ³¡éºµ/å³é£Ÿ',checked:false}, {id:84,cat:'food',name:'æ°´æœ',checked:false}, {id:90,cat:'other',name:'ç™»å±±èƒŒåŒ…(40L)',checked:true}, {id:91,cat:'other',name:'æ›¬è¡£å¤¾',checked:true}, {id:92,cat:'other',name:'æ´—è¡£è¢‹',checked:true}, {id:93,cat:'other',name:'è…°åŒ…',checked:false}, {id:94,cat:'other',name:'ç™»å±±æ–',checked:true}, {id:95,cat:'other',name:'å¡‘è† è¢‹/åƒåœ¾è¢‹',checked:false}, {id:96,cat:'other',name:'ç’°ä¿é¤å…·',checked:true}, {id:97,cat:'other',name:'ç‘å£«åˆ€',checked:false}, {id:98,cat:'other',name:'æ‰“ç«æ©Ÿ',checked:false}, {id:99,cat:'other',name:'é˜²èšŠæ¶²',checked:false}, {id:100,cat:'other',name:'å£ç½©',checked:false}, {id:101,cat:'other',name:'å“¨å­',checked:false}, {id:102,cat:'other',name:'åœ°åœ–',checked:false}, {id:103,cat:'other',name:'æŸç·šå¸¶',checked:false}]; this.saveData(); },
            getStayCostByDate(date) { const stay = this.data.stays.find(s => s.date === date); return stay ? Number(stay.price || 0) : 0; },
            addFab(c,i,cb) { const b=document.createElement('div'); b.className='fab'; b.innerHTML=`<i class="fa-solid ${i}"></i>`; b.onclick=cb; c.appendChild(b); },
            showModal(t,h) { document.getElementById('modal-title').innerText=t; document.getElementById('modal-content').innerHTML=h; document.getElementById('modal').classList.remove('hidden'); },
            closeModal() { document.getElementById('modal').classList.add('hidden'); },
            closeMapModal() { document.getElementById('map-modal').classList.add('hidden'); },
            closeImportModal() { document.getElementById('import-modal').classList.add('hidden'); },
            addExpenseRow(name = '', price = '') { const div = document.createElement('div'); div.className = 'flex gap-2 expense-row'; div.innerHTML = `<input type="text" class="input-field py-1 text-sm flex-[2] ex-name" placeholder="é …ç›®" value="${name}"><input type="number" class="input-field py-1 text-sm flex-1 ex-price" placeholder="$" value="${price}"><button onclick="this.parentElement.remove()" class="text-gray-400 px-1"><i class="fa-solid fa-xmark"></i></button>`; document.getElementById('expense-container').appendChild(div); },
            deleteLog(id) { if(confirm('åˆªé™¤?')) { this.data.logs = this.data.logs.filter(l => l.id !== id); this.saveData(); this.closeModal(); this.router('log'); }}
        };

        document.addEventListener('DOMContentLoaded', () => { App.init(); });
    </script>
</body>
</html>
